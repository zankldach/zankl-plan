
{% extends "base.html" %}
{% block title %}Wochenplanung Zankl Dach – KW {{ kw }} / {{ year }}{% endblock %}

{% block head %}
<style>
  /* ===== Layout: Wochenplan links, Kleinbaustellen rechts ===== */
  .layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 12px;
    align-items: start;
  }
  header.page { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

  /* ===== Toolbar ===== */
  .toolbar { display:flex; gap:16px; align-items:center; flex-wrap: wrap; margin-bottom:8px; }
  .toolbar .group { display:flex; gap:8px; align-items:center; }
  .toolbar label { font-weight: 600; }
  .toolbar select, .toolbar button, .toolbar input[type="checkbox"] { padding: 6px 8px; font-size: 14px; }
  .toolbar .badge { display:inline-block; padding:4px 8px; background:#eef2f6; border-radius:999px; font-size:12px; color:#334155; }

  /* ===== Wochenplan Tabelle ===== */
  #weekTable {
    width: 100%;
    border-collapse: separate; border-spacing: 0; table-layout: fixed;
    background: #fff; border: 1px solid #d9dee5; border-radius: 8px; overflow: hidden;
    box-shadow: 0 3px 12px rgba(0,0,0,0.06);
  }
  #weekTable thead th {
    position: sticky; top: 0; z-index: 3;
    background: #0b57d0; color: #fff; padding: 8px 6px; font-weight: 700;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    text-align: center;
  }
  #weekTable thead th:first-child,
  #weekTable tbody td:first-child {
    position: sticky; left: 0; z-index: 2;
    background: #f7f9fc; font-weight: 600; width: 180px; text-align: left;
  }
  #weekTable tbody td { border-top: 1px solid #eef2f6; border-right: 1px solid #eef2f6; padding: 0 6px; height: 42px; vertical-align: middle; }
  #weekTable tbody tr:nth-child(even) td:first-child { background: #f1f5fb; }
  #weekTable tbody tr:hover td { background: #fbfdff; }
  #weekTable input.cell {
    width: 100%; height: 32px; padding: 4px 6px;
    border: none; background: transparent;
    text-align: center; font-size: 13px; outline: none;
  }
  #weekTable input.cell:focus { outline: 2px solid #7db3ff; background: #fff; border-radius: 6px; }
  .drag-over { outline: 2px dashed #2196f3; outline-offset: -4px; background: #eef7ff !important; }
  .paint-select { outline: 2px dashed #fb923c; outline-offset: -4px; background: #fff7ed !important; }
  td.disabled-day { background: #eceff4 !important; }
  td.disabled-day input.cell { color: #64748b; }
  td .hint { position:absolute; top:4px; left:4px; font-size:10px; color:#64748b; }

  /* ===== Kleinbaustellen Panel ===== */
  .side { background: #fff; border: 1px solid #d9dee5; border-radius: 8px; box-shadow: 0 3px 12px rgba(0,0,0,0.06); }
  .side header {
    background: #0b57d0; color: #fff; padding: 8px 12px; font-weight: 700;
    border-bottom: 1px solid rgba(255,255,255,0.2); position: sticky; top: 0; z-index: 2;
  }
  .side .list { max-height: 70vh; overflow-y: auto; padding: 8px 12px; }
  .side .row { display:flex; align-items:center; gap:8px; margin-bottom:8px; position: relative; }
  .side .row .drag-handle { cursor: grab; user-select: none; position: relative; z-index: 1; }
  .side .row input.job {
    flex:1; padding:6px 8px; border:1px solid #d9dee5; border-radius:6px;
    position: relative; z-index: 2;
    opacity: 1 !important; visibility: visible !important; pointer-events: auto !important;
    color:#111 !important; caret-color:#111 !important;
    background:#fff !important; filter:none !important; transform:none !important;
  }
  .job.selected { outline: 2px solid #94a3b8; background: #f1f5f9; }
</style>
{% endblock %}

{% block content %}
<header class="page">
  <strong style="font-size:18px;">Zankl Dach – Wochenplanung</strong>
</header>

<div class="toolbar">
  <div class="group">
    <label for="locationSelect">Standort:</label>
    <select id="locationSelect">
      {% for s in standorte %}
        {% set s_val = (s|string) %}
        <option value="{{ s_val }}" {{ 'selected' if s_val==(standort|string) else '' }}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="group">
    <button id="prevWeekBtn">←</button>
    <label for="kwSelect">KW:</label>
    <select id="kwSelect"></select>
    <label for="yearSelect">Jahr:</label>
    <select id="yearSelect"></select>
    <button id="nextWeekBtn">→</button>
    <button id="goBtn">Öffnen</button>
  </div>

  <div class="group">
    <label for="fourDayChk">4‑Tage‑Woche:</label>
    <input type="checkbox" id="fourDayChk" {% if four_day_week %}checked{% endif %} />
    <span class="badge">KW {{ kw }} / {{ year }}</span>
  </div>
</div>

<div class="layout">
  <!-- Wochenplan -->
  <div class="plan-wrap">
    <table class="planner" id="weekTable">
      <thead>
        <tr>
          <th>Mitarbeiter / Tag</th>
          {% for day in days %}
            <th>{{ day.label }}<br><small>{{ day.date }}</small></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% if grid is defined %}
          {% for row in grid %}
            {% set r = loop.index0 %}
            <tr>
              <td>
                {% if employees and employees|length > r and employees[r] %}
                  {{ employees[r].name }}
                {% else %}Unbenannt{% endif %}
              </td>
              {% for cell in row %}
                {% set d = loop.index0 %}
                <td data-row="{{ r }}" data-day="{{ d }}">
                  <input class="cell" draggable="true" value="{{ cell.text if cell and cell.text is defined else '' }}"
                         data-row="{{ r }}" data-day="{{ d }}">
                  {% if d == 4 %}<span class="hint"></span>{% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% else %}
          {% for r in range(row_count) %}
            <tr>
              <td>
                {% if employees and employees|length > r and employees[r] %}
                  {{ employees[r].name }}
                {% else %}Unbenannt{% endif %}
              </td>
              {% for d in range(5) %}
                <td data-row="{{ r }}" data-day="{{ d }}">
                  <input class="cell" draggable="true"
                         value="{{ week_cells.get((r,d), '') if week_cells is defined else '' }}"
                         data-row="{{ r }}" data-day="{{ d }}">
                  {% if d == 4 %}<span class="hint"></span>{% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
    <div style="margin-top:10px;">
      <button id="saveAllBtn">Alles speichern</button>
    </div>
  </div>

  <!-- Sidebar: Kleinbaustellen (standortweit) -->
  <div>
    <div class="side">
      <header>Kleinbaustellen</header>
      <div class="list" id="kleinList">
        {% set list = small_jobs or [] %}
        {% for item in list %}
          {% set txt = '' %}
          {% if item is string %}
            {% set txt = item %}
          {% elif item.text is defined %}
            {% set txt = item.text %}
          {% endif %}
        <div class="row">
          <span class="drag-handle" title="Ziehen in Wochenzelle" draggable="true">⋮⋮</span>
          <input type="text" class="job" data-row="{{ loop.index0 }}" value="{{ txt }}" placeholder="">
        </div>
        {% endfor %}
        {% if (not list) or (list|length==0) %}
        <div class="row">
          <span class="drag-handle" title="Ziehen in Wochenzelle" draggable="true">⋮⋮</span>
          <input type="text" class="job" data-row="0" value="" placeholder="">
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    // ---- Kontext ----
    const KW     = parseInt('{{ kw }}', 10);
    const YEAR   = parseInt('{{ year }}', 10);
    const CURLOC = "{{ (standort|string) }}";
    const MAX_WEEKS = 53;
    const FOUR_DAY = !!({{ 1 if four_day_week else 0 }});

    // ---- Plan-Key (für lokalen Freitag-Cache) ----
    const PLAN_KEY = (loc, kw, year) => `${loc}|${kw}|${year}`;
    const planKey = PLAN_KEY(CURLOC, KW, YEAR);

    // ---- Selects füllen ----
    function initSelectors(){
      const kwSel = document.getElementById('kwSelect');
      const yearSel = document.getElementById('yearSelect');
      kwSel.innerHTML = "";
      for (let w=1; w<=MAX_WEEKS; w++){
        const opt = document.createElement('option');
        opt.value = w; opt.textContent = w;
        if (w === KW) opt.selected = true;
        kwSel.appendChild(opt);
      }
      yearSel.innerHTML = "";
      [YEAR-1, YEAR, YEAR+1].forEach(y=>{
        const opt = document.createElement('option');
        opt.value = y; opt.textContent = y;
        if (y === YEAR) opt.selected = true;
        yearSel.appendChild(opt);
      });
    }
    initSelectors();

    // ---- 4-Tage-Woche ----
    const fourChk = document.getElementById('fourDayChk');
    function restoreFridayFromCache() {
      const cacheRaw = localStorage.getItem(`fridayCache:${planKey}`);
      if (!cacheRaw) return;
      const cache = JSON.parse(cacheRaw);
      document.querySelectorAll('#weekTable td[data-day="4"] input.cell').forEach((inp, idx) => {
        if (!inp.value && cache && typeof cache[idx] === 'string') {
          inp.value = cache[idx];
        }
      });
    }
    function cacheFridayTexts() {
      const vals = Array.from(document.querySelectorAll('#weekTable td[data-day="4"] input.cell')).map(inp => inp.value || "");
      localStorage.setItem(`fridayCache:${planKey}`, JSON.stringify(vals));
    }
    function applyFourDayWeekUI(flag){
      document.querySelectorAll('#weekTable td[data-day="4"]').forEach(td=>{
        const inp = td.querySelector('input.cell');
        if(flag){
          td.classList.add('disabled-day');
          if(inp) inp.disabled = true;
          const hint = td.querySelector('.hint');
          if (hint) hint.textContent = "gesperrt";
        } else {
          td.classList.remove('disabled-day');
          if(inp) inp.disabled = false;
          const hint = td.querySelector('.hint');
          if (hint) hint.textContent = "";
          if(inp){ inp.style.background=''; inp.style.color=''; }
        }
      });
      // Nach UI-Umschaltung: Freitagstexte nie löschen; bei 4-Tage ggf. aus Cache sichtbar machen
      if (flag) restoreFridayFromCache();
    }
    async function setFourDayWeek(flag){
      const payload = {
        year: YEAR, kw: KW, standort: (document.getElementById('locationSelect').value || CURLOC),
        four_day_week: !!flag
      };
      try{
        const res = await fetch('/api/week/options', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        if (!res.ok) console.warn('4-Tage-Woche speichern fehlgeschlagen', await res.text());
      }catch(e){ console.warn('Netz-/Serverfehler bei 4-Tage-Woche:', e); }
    }
    fourChk.addEventListener('change', async ()=>{
      const flag = fourChk.checked;
      // Vor Umschaltung: aktuelle Freitag-Werte cachen
      cacheFridayTexts();
      applyFourDayWeekUI(flag);
      applyColors();
      await setFourDayWeek(flag);
    });
    applyFourDayWeekUI(FOUR_DAY);
    // Bei erstem Laden: falls 4-Tage aktiv und Backend Freitag leer liefert, aus Cache sichtbar machen
    if (FOUR_DAY) restoreFridayFromCache();

    // ---- Farben ----
    const RESERVED_RED = new Set(["urlaub","krank","arzt","za","xxx"]);
    const norm = s => (s || "").trim().toLowerCase().replace(/\s+/g, " ");
    function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
    function colorFor(text){
      const n = norm(text);
      if(!n) return null;
      if (RESERVED_RED.has(n)) {
        return { bg: "hsla(0, 85%, 75%, 0.65)", border: "hsl(0, 85%, 45%)" };
      }
      let h = hashCode(n) % 360;
      const isRedish = (h <= 20) || (h >= 340);
      if (isRedish) h = (h + 40) % 360;
      const s = 70, l = 80;
      return { bg:`hsla(${h}, ${s}%, ${l}%, 0.65)`, border:`hsl(${h}, ${s}%, ${Math.max(40,l-25)}%)` };
    }
    function applyColors(){
      document.querySelectorAll('#weekTable input.cell').forEach(inp=>{
        const c = colorFor(inp.value);
        if(c){
          inp.style.background=c.bg;
          inp.style.border=`1px solid ${c.border}`;
          inp.style.borderRadius='6px';
        } else {
          inp.style.background='transparent';
          inp.style.border='none';
        }
      });
    }

    // ---- Speichern Wochenzellen ----
    async function saveCell(row, day, value){
      // Vor jedem Speichern: Freitag-Cache aktualisieren (damit er beim Reload sichtbar bleibt)
      if (Number(day) === 4) cacheFridayTexts();
      if (fourChk.checked && Number(day) === 4) return true; // Backend skippt bei 4-Tage
      try{
        const res = await fetch('/api/week/set-cell',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            row:Number(row), day:Number(day), value:value ?? "",
            kw: parseInt(document.getElementById('kwSelect').value || '{{ kw }}',10),
            year: parseInt(document.getElementById('yearSelect').value || '{{ year }}',10),
            standort: (document.getElementById('locationSelect').value || CURLOC)
          })
        });
        if (!res.ok) { console.warn('Save HTTP-Fehler:', res.status); return false; }
        const r = await res.json().catch(()=>({ok:true}));
        if(!r.ok) { console.warn('Save-Fehler:', r.error); return false; }
        return true;
      }catch(e){ console.warn('Netz-/Serverfehler:', e); return false; }
    }
    async function saveBatch(updates){
      // Cache Freitag mit, auch wenn Backend skippt
      cacheFridayTexts();
      if (fourChk.checked) updates = updates.filter(u => Number(u.day) !== 4);
      try{
        const res = await fetch('/api/week/batch',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            year: parseInt(document.getElementById('yearSelect').value || '{{ year }}',10),
            kw:   parseInt(document.getElementById('kwSelect').value  || '{{ kw }}',10),
            standort: (document.getElementById('locationSelect').value || CURLOC),
            updates
          })
        });
        if (!res.ok) { console.warn('Batch HTTP-Fehler:', res.status); return false; }
        const r = await res.json().catch(()=>({ok:true}));
        if(!r.ok) { console.warn('Batch-Fehler:', r.error); return false; }
        return true;
      }catch(e){ console.warn('Netz-/Serverfehler:', e); return false; }
    }
    document.getElementById('saveAllBtn').onclick = async ()=>{
      const updates=[];
      document.querySelectorAll('#weekTable input.cell').forEach(inp=>{
        updates.push({ row:Number(inp.dataset.row), day:Number(inp.dataset.day), value: inp.value ?? "" });
      });
      const ok = await saveBatch(updates);
      alert(ok ? 'Alle Zellen gespeichert.' : 'Speichern fehlgeschlagen.');
    };

    // ---- Kleinbaustellen (global je Standort) ----
    const kleinList = document.getElementById('kleinList');
    function renumberJobs(){
      const list = kleinList.querySelectorAll('input.job');
      list.forEach((inp, idx)=> inp.dataset.row = String(idx));
    }
    function ensureTrailingEmptyJob(){
      const list = kleinList.querySelectorAll('input.job');
      const last = list[list.length-1];
      if (!last || (last.value||"").trim() !== ""){
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <span class="drag-handle" title="Ziehen in Wochenzelle" draggable="true">⋮⋮</span>
          <input type="text" class="job" data-row="${list.length}" value="" placeholder="">
        `;
        kleinList.appendChild(row);
        bindJobInput(row.querySelector('input.job'));
      }
      renumberJobs();
    }
    async function saveSmallJob(row_index, text){
      try{
        const res = await fetch('/api/klein/set',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            standort:(document.getElementById('locationSelect').value || CURLOC),
            row_index:Number(row_index), text:text ?? ""
          })
        });
        if (!res.ok) console.warn('Klein HTTP-Fehler:', res.status, await res.text());
      }catch(e){ console.warn('Netz-/Serverfehler (klein):', e); }
    }
    function bindJobInput(input){
      const rowDiv = input.closest('.row');
      let handle = rowDiv.querySelector('.drag-handle');
      if (!handle) {
        handle = document.createElement('span');
        handle.className = 'drag-handle';
        handle.textContent = '⋮⋮';
        handle.title = 'Ziehen in Wochenzelle';
        handle.setAttribute('draggable', 'true');
        rowDiv.insertBefore(handle, input);
      }
      // Nur Handle ist draggable
      handle.addEventListener('dragstart', e => {
        const value = (input.value || '').trim();
        if (!value) { e.preventDefault(); return; }
        e.dataTransfer.setData('text/plain', JSON.stringify({ source:'klein', value }));
        e.dataTransfer.dropEffect = 'copy';
        input.classList.add('dragging');
      });
      handle.addEventListener('dragend', () => input.classList.remove('dragging'));

      // Doppelklick = optischer Fokus
      input.addEventListener('dblclick', () => {
        document.querySelectorAll('.job').forEach(el => el.classList.remove('selected'));
        input.classList.add('selected');
      });
      // Entf = löschen + speichern
      input.addEventListener('keydown', async ev => {
        if (ev.key === 'Delete'){
          ev.preventDefault();
          input.value = '';
          input.classList.remove('selected');
          await saveSmallJob(input.dataset.row, '');
          ensureTrailingEmptyJob();
        }
      });
      // Tippen: freie Zeile unten nachführen
      input.addEventListener('input', () => { ensureTrailingEmptyJob(); });
      // Blur: speichern
      input.addEventListener('blur', async () => {
        await saveSmallJob(input.dataset.row, input.value);
        ensureTrailingEmptyJob();
      });
    }
    document.querySelectorAll('.job').forEach(bindJobInput);
    ensureTrailingEmptyJob();

    // Vor Navigation / Reload: alle Kleinbaustellen synchron sichern
    window.addEventListener('beforeunload', () => {
      const items = Array.from(document.querySelectorAll('#kleinList input.job'))
        .map((inp, idx) => ({ row_index: idx, text: (inp.value || '').trim() }));
      const payload = {
        standort:(document.getElementById('locationSelect').value || CURLOC),
        items
      };
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      // Versuch: /api/klein/save-list (falls vorhanden)
      if (navigator.sendBeacon) {
        navigator.sendBeacon('/api/klein/save-list', blob);
      }
      // Fallback: einzelne Zellen via fetch keepalive
      items.forEach(it => {
        fetch('/api/klein/set', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ standort: payload.standort, row_index: it.row_index, text: it.text }),
          keepalive: true
        }).catch(()=>{});
      });
    });

    // ---- DnD im Wochenraster ----
    let dragData=null;
    function attachDnD(){
      const cells = document.querySelectorAll('#weekTable td');
      const inputs = document.querySelectorAll('#weekTable input.cell');
      inputs.forEach(inp=>{
        inp.addEventListener('dragstart',e=>{
          dragData = { source:'grid', row:Number(inp.dataset.row), day:Number(inp.dataset.day), value: inp.value };
          e.dataTransfer.setData('text/plain', JSON.stringify(dragData));
          e.dataTransfer.dropEffect='move';
          inp.classList.add('dragging');
        });
        inp.addEventListener('dragend',()=>{
          document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
          document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
          dragData=null;
        });
        inp.addEventListener('blur', async ()=>{
          await saveCell(inp.dataset.row, parseInt(inp.dataset.day,10), inp.value);
          applyColors();
        });
        inp.addEventListener('keydown', async (ev)=>{
          if(ev.key==='Enter'){
            ev.preventDefault();
            await saveCell(inp.dataset.row, parseInt(inp.dataset.day,10), inp.value);
            applyColors();
            const r=Number(inp.dataset.row), d=Number(inp.dataset.day);
            const next = document.querySelector(`input.cell[data-row="${r}"][data-day="${d+1}"]`);
            (next||inp).focus();
          }
        });
        inp.addEventListener('input', applyColors);
      });
      cells.forEach(td=>{
        td.addEventListener('dragover',e=>{
          e.preventDefault();
          const targetDay = Number(td.dataset.day);
          if (fourChk.checked && targetDay === 4) return;
          td.classList.add('drag-over');
        });
        td.addEventListener('dragleave',()=> td.classList.remove('drag-over'));
        td.addEventListener('drop', async e=>{
          e.preventDefault();
          td.classList.remove('drag-over');
          try{
            const payload = dragData || JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
            const targetRow = Number(td.dataset.row);
            const targetDay = Number(td.dataset.day);
            if (fourChk.checked && targetDay === 4) return;

            const tgtInput = td.querySelector('input.cell');
            if(!tgtInput) return;

            if (payload && payload.source === 'klein') {
              const value = payload.value ?? "";
              tgtInput.value = value;
              await saveCell(targetRow, targetDay, value);
              applyColors();
              return;
            }

            if (payload && payload.source === 'grid') {
              const srcInput = document.querySelector(`input.cell[data-row="${payload.row}"][data-day="${payload.day}"]`);
              if(!srcInput) return;
              const copy = e.ctrlKey || e.metaKey;
              tgtInput.value = payload.value;
              await saveCell(targetRow, targetDay, payload.value);
              if(!copy && (payload.row!==targetRow || payload.day!==targetDay)){
                srcInput.value = "";
                await saveCell(payload.row, payload.day, "");
              }
              applyColors();
            }
          }catch(err){ console.warn('Drop-Fehler:', err); }
        });
      });
    }

    // ---- Bereich-Füllen (Shift + Maus) ----
    function getCellInput(row, day) { return document.querySelector(`#weekTable input.cell[data-row="${row}"][data-day="${day}"]`); }
    function getCellTd(row, day)    { return document.querySelector(`#weekTable td[data-row="${row}"][data-day="${day}"]`); }
    function paintRange(row, d1, d2, on=true) {
      const [from, to] = d1 <= d2 ? [d1, d2] : [d2, d1];
      for (let d = from; d <= to; d++) {
        if (fourChk.checked && d === 4) continue;
        const td = getCellTd(row, d); if (!td) continue;
        td.classList.toggle('paint-select', on);
      }
    }
    const fillState = { active:false, row:null, startDay:null, lastDay:null, value:"" };
    function startFill(row, day, value) {
      fillState.active = true; fillState.row = row; fillState.startDay = day; fillState.lastDay = day;
      fillState.value = value ?? ""; paintRange(row, day, day, true);
    }
    function updateFill(day) {
      if (!fillState.active) return;
      paintRange(fillState.row, fillState.startDay, fillState.lastDay, false);
      fillState.lastDay = day;
      paintRange(fillState.row, fillState.startDay, fillState.lastDay, true);
    }
    async function endFill() {
      if (!fillState.active) return;
      const row = fillState.row;
      const d1  = Math.min(fillState.startDay, fillState.lastDay);
      const d2  = Math.max(fillState.startDay, fillState.lastDay);
      let updates = [];
      for (let d = d1; d <= d2; d++) {
        if (fourChk.checked && d === 4) continue;
        const inp = getCellInput(row, d); if (!inp) continue;
        inp.value = fillState.value;
        updates.push({ row, day:d, value: fillState.value });
      }
      await saveBatch(updates);
      applyColors();
      paintRange(row, d1, d2, false);
      fillState.active = false; fillState.row = null; fillState.startDay = null; fillState.lastDay = null; fillState.value = "";
    }
    function attachPaintFill() {
      const tds = document.querySelectorAll('#weekTable td');
      tds.forEach(td => {
        const row = Number(td.dataset.row), day = Number(td.dataset.day);
        const inp = td.querySelector('input.cell');
        td.addEventListener('mousedown', (e) => {
          if (e.button !== 0 || !e.shiftKey) return;
          if (fourChk.checked && day === 4) return;
          e.preventDefault();
          const startValue = (inp?.value ?? "");
          startFill(row, day, startValue);
        });
        td.addEventListener('mouseenter', () => {
          if (fillState.active && row === fillState.row) updateFill(day);
        });
      });
      document.addEventListener('mouseup', () => { if (fillState.active) endFill(); });
      document.addEventListener('mouseleave', () => { if (fillState.active) endFill(); });
    }

    // ---- Navigation ----
    function navigate(standort, kw, year){
      const url = `/week?standort=${encodeURIComponent(standort)}&kw=${kw}&year=${year}`;
      window.location.href = url;
    }
    document.getElementById('locationSelect').onchange = ()=>{
      const loc = document.getElementById('locationSelect').value || CURLOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      navigate(loc, kw, yr);
    };
    document.getElementById('prevWeekBtn').onclick = ()=>{
      const loc = document.getElementById('locationSelect').value || CURLOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      const p   = (kw>1) ? {kw: kw-1, year: yr} : {kw: MAX_WEEKS, year: yr-1};
      navigate(loc, p.kw, p.year);
    };
    document.getElementById('nextWeekBtn').onclick = ()=>{
      const loc = document.getElementById('locationSelect').value || CURLOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      const n   = (kw<MAX_WEEKS) ? {kw: kw+1, year: yr} : {kw: 1, year: yr+1};
      navigate(loc, n.kw, n.year);
    };
    document.getElementById('goBtn').onclick = ()=>{
      const loc = document.getElementById('locationSelect').value || CURLOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      navigate(loc, kw, yr);
    };

    // ---- Init ----
    attachDnD();
    attachPaintFill();
    applyColors();

  } catch (err) {
    console.error('Init-Fehler in week.html:', err);
    alert('Fehler beim Laden der Wochenansicht. Bitte Seite hart neu laden (Strg+F5).');
  }
});
</script>
{% endblock %}
