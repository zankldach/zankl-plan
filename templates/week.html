<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Wochenplanung</title>
    <link rel="stylesheet" href="/static/style.v2.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; min-width: 120px; }
        th { background-color: #f0f0f0; }
        .job-cell { cursor: pointer; user-select: none; }
    </style>
</head>
<body>
    <h1>Wochenplanung {{ year }} KW {{ kw }} - Standort: {{ standort_id }}</h1>

    <table>
        <thead>
            <tr>
                <th>Mitarbeiter</th>
                {% for day in days %}
                    <th>{{ day.label }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for i in range(employee_lines) %}
                <tr>
                    <td contenteditable="true" class="employee-name">
                        {% if employees and employees|length > i %}
                            {{ employees[i] }}
                        {% else %}
                            Mitarbeiter {{ i + 1 }}
                        {% endif %}
                    </td>
                    {% for d in range(workdays) %}
                        {% set cell = grid[i][d] %}
                        <td class="job-cell" contenteditable="true"
                            data-row="{{ i }}" data-day="{{ d }}" style="background-color: {{ cell.color if cell and cell.color else '' }}">
                            {% if cell %}
                                {% if cell.title %}{{ cell.title }}{% endif %}
                            {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        $(document).ready(function(){
            // Job-Zellen editieren
            $(".job-cell").on("input", function(){
                const row = $(this).data("row");
                const day = $(this).data("day");
                const title = $(this).text();
                const cell = $(this);

                $.post("/api/week/set-cell", {
                    week_plan_id: {{ week_plan_id }},
                    row_index: row,
                    day_index: day,
                    job_title: title
                }, function(data){
                    if(data.success){
                        // Hintergrundfarbe gleich für gleiche Jobs
                        $(".job-cell").each(function(){
                            if($(this).text() === title && title !== ""){
                                $(this).css("background-color", "#ffd700"); // Gelb als Standard
                            }
                        });
                    }
                });
            });

            // Mitarbeiter ziehen / kopieren
            $(".employee-name").on("input", function(){
                const val = $(this).text();
                const row = $(this).closest("tr").index();
                // hier könntest du speichern via API, falls gewünscht
            });
        });
    </script>
</body>
</html>
