<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wochenplanung Zankl Engelbrechts</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
header { background: #003a8f; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
select { padding: 5px; font-size: 14px; }
table { width: 100%; border-collapse: collapse; background: white; }
th, td { border: 1px solid #ddd; padding: 6px; text-align: center; min-width: 110px; }
th { background: #eef2f6; }
td { cursor: pointer; }
td input { width: 100%; border: none; background: transparent; text-align: center; font-size: 14px; }
</style>
</head>

<body>

<header>
    <strong>Wochenplanung Zankl Engelbrechts</strong>
    <div>
        KW:
        <select id="kw"></select>
        Jahr:
        <select id="year"></select>
    </div>
</header>

<table id="weekTable">
    <thead>
        <tr>
            <th>Mitarbeiter</th>
            {% for d in days %}
                <th>{{ d.label }} {{ d.date }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
/* ---------- Einstellungen ---------- */
const WORKDAYS = 5;
let EMPLOYEE_LINES = {{ grid|length }};
let dragValue = null;

/* ---------- Farben ---------- */
const SPECIAL_RED = ['urlaub','krank','za','xxx'];
const colors = {};
const palette = ['#d1e7ff','#ffe0b2','#dcedc8','#f8bbd0','#e1bee7','#c8e6c9','#fff9c4','#b2ebf2'];
let colorIndex = 0;

/* ---------- KW & Jahr ---------- */
const kwSelect = document.getElementById('kw');
const yearSelect = document.getElementById('year');
for (let i=1;i<=53;i++) kwSelect.innerHTML += `<option>${i}</option>`;
for (let y=new Date().getFullYear()-1;y<=new Date().getFullYear()+2;y++) yearSelect.innerHTML += `<option>${y}</option>`;

kwSelect.value = {{ kw }};
yearSelect.value = {{ year }};

kwSelect.onchange = yearSelect.onchange = () => {
    location.href = `?kw=${kwSelect.value}&year=${yearSelect.value}`;
};

/* ---------- Tabelle ---------- */
const tbody = document.querySelector('#weekTable tbody');

/* Mitarbeiterliste aus DB laden */
let employeeNames = {% if employees %}{{ employees|tojson }}{% else %}[] {% endif %};
if(employeeNames.length === 0){
    employeeNames = Array.from({length: EMPLOYEE_LINES}, (_,i)=>`Mitarbeiter ${i+1}`);
}

function buildTable(grid){
    tbody.innerHTML = '';
    EMPLOYEE_LINES = Math.max(grid.length, employeeNames.length);

    for(let r=0;r<EMPLOYEE_LINES;r++){
        const tr = document.createElement('tr');
        const name = employeeNames[r] || `Mitarbeiter ${r+1}`;
        tr.innerHTML = `<th>${name}</th>`;

        for(let d=0; d<WORKDAYS; d++){
            const td = document.createElement('td');
            const input = document.createElement('input');
            const value = grid[r]?.[d]?.text || '';
            input.value = value;
            applyColor(td,value);

            input.oninput = () => applyColor(td,input.value);
            input.onchange = () => saveCell(r,d,input.value);

            input.onmousedown = (e)=>{ if(e.button===2) dragValue=input.value; };
            input.onmouseover = ()=>{ if(dragValue!==null){ input.value=dragValue; applyColor(td,dragValue); saveCell(r,d,dragValue); } };
            input.onmouseup = ()=>dragValue=null;
            td.appendChild(input);
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }
}

/* ---------- Farben ---------- */
function applyColor(td,value){
    if(!value){ td.style.background=''; return; }
    const v=value.toLowerCase();
    if(SPECIAL_RED.includes(v)){ td.style.background='#f28b82'; return; }
    if(!colors[v]){ colors[v]=palette[colorIndex % palette.length]; colorIndex++; }
    td.style.background = colors[v];
}

/* ---------- Speichern ---------- */
async function saveCell(row,day,value){
    try{
        await fetch('/api/week/set-cell',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({kw:{{ kw }},year:{{ year }},row:row,day:day,value:value})
        });
    }catch(e){ console.warn('Speichern fehlgeschlagen'); }
}

/* ---------- Initialisieren ---------- */
const initialGrid = {{ grid|tojson }};
buildTable(initialGrid);

/* Kontextmenü für Drag unterdrücken */
document.addEventListener('contextmenu', e=>{ if(e.target.tagName==='INPUT') e.preventDefault(); });
</script>

</body>
</html>
