<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <title>Zankl Plan – Wochenplanung</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/style.v2.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 350px;
        }
        .modal-close { float: right; cursor: pointer; font-weight: bold; }
        .job-item { cursor: pointer; padding: 4px; }
        .job-item:hover { background-color: #eee; }
        #newJobInput { width: 100%; margin-top: 10px; }
        #addJobBtn { margin-top: 5px; width: 100%; }
    </style>
</head>
<body>

<header class="topbar">
    <div class="logo">Zankl GmbH</div>
</header>

<main class="container">

<h2>Wochenansicht – KW {{ kw }} / {{ year }}</h2>

<!-- Standorte -->
<div class="standorte">
    {% for s in standorte %}
        <a href="/week?standort_id={{ s.id }}&kw={{ kw }}&year={{ year }}">{{ s.name }}</a>
    {% endfor %}
</div>

<hr>

<!-- GRID -->
<table border="1" cellpadding="6">
    <thead>
        <tr>
            <th>Zeile</th>
            {% for day in days %}
                <th>{{ day.label }}<br><small>{{ day.date }}</small></th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for r in range(employee_lines) %}
        <tr>
            <td>{{ r + 1 }}</td>
            {% for d in range(workdays) %}
            <td class="cell" data-row="{{ r }}" data-day="{{ d }}">
                {% set cell = grid[r][d] %}
                {% if cell and cell.title %}
                    <strong>{{ cell.title }}</strong>
                {% else %}
                    frei
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

</main>

<!-- Modal für Job-Auswahl / Neu -->
<div id="jobModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h3>Job auswählen oder neuen Job eintragen</h3>

        <div id="jobList">
            {% for job in jobs|sort(attribute='title') %}
                <div class="job-item" data-job-id="{{ job.id }}">{{ job.title }}</div>
            {% endfor %}
            <div class="job-item" data-job-id="">frei</div>
        </div>

        <input type="text" id="newJobInput" placeholder="Neuen Job eintragen">
        <button id="addJobBtn">Job hinzufügen</button>
    </div>
</div>

<script>
$(document).ready(function() {
    let selectedCell = null;

    // Zelle anklicken → Modal öffnen
    $(".cell").click(function() {
        selectedCell = $(this);
        $("#jobModal").show();
    });

    // Modal schließen
    $(".modal-close").click(function() {
        $("#jobModal").hide();
    });

    function saveCell(jobId, jobTitle) {
        const weekPlanId = {{ week_plan_id }};
        const row = selectedCell.data("row");
        const day = selectedCell.data("day");

        $.post("/api/week/set-cell", {
            week_plan_id: weekPlanId,
            row_index: row,
            day_index: day,
            job_id: jobId,
            job_title: jobTitle  // nur für neue Jobs
        }, function(response) {
            if (response.success) {
                selectedCell.html("<strong>" + response.title + "</strong>");
            } else {
                alert("Fehler beim Setzen der Zelle: " + response.error);
            }
            $("#jobModal").hide();
        }, "json");
    }

    // Job aus Liste auswählen
    $(".job-item").click(function() {
        const jobId = $(this).data("job-id");
        const jobTitle = $(this).text();
        saveCell(jobId, null);
    });

    // Neuen Job anlegen
    $("#addJobBtn").click(function() {
        const newJob = $("#newJobInput").val().trim();
        if (newJob === "") {
            alert("Bitte Jobname eingeben.");
            return;
        }
        saveCell(null, newJob);
    });
});
</script>

</body>
</html>
