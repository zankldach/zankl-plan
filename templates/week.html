        }
        });
        inp.addEventListener('input', applyColors);
      });

      cells.forEach(td=>{
        td.addEventListener('dragover',e=>{
          e.preventDefault();
          const targetDay = Number(td.dataset.day);
          if (fourChk.checked && targetDay === 4) return; // Freitag gesperrt
          td.classList.add('drag-over');
        });
        td.addEventListener('dragleave',()=> td.classList.remove('drag-over'));
        td.addEventListener('drop', async e=>{
          e.preventDefault();
          td.classList.remove('drag-over');
          try{
            const payload = dragData || JSON.parse(e.dataTransfer.getData('text/plain')||'{}');
            const targetRow = Number(td.dataset.row);
            const targetDay = Number(td.dataset.day);
            if (fourChk.checked && targetDay === 4) return;

            const tgtInput = td.querySelector('input.cell');
            if(!tgtInput) return;

            if (payload && payload.source === 'klein') {
              const value = payload.value ?? "";
              tgtInput.value = value;
              await saveCell(targetRow, targetDay, value);
              applyColors();
              return;
            }

            if (payload && payload.source === 'grid') {
              const srcInput = document.querySelector(`input.cell[data-row="${payload.row}"][data-day="${payload.day}"]`);
              if(!srcInput) return;
              const copy = e.ctrlKey || e.metaKey;

              tgtInput.value = payload.value;
              await saveCell(targetRow, targetDay, payload.value);

              if(!copy && (payload.row!==targetRow || payload.day!==targetDay)){
                srcInput.value = "";
                await saveCell(payload.row, payload.day, "");
              }
              applyColors();
            }
          }catch(err){ console.warn('Drop-Fehler:', err); }
        });
      });
    }

    /* ---------- Bereich-FÃ¼llen (Shift + Ziehen) ---------- */
    function getCellInput(row, day) {
      return document.querySelector(`#weekTable input.cell[data-row="${row}"][data-day="${day}"]`);
    }
    function getCellTd(row, day) {
      return document.querySelector(`#weekTable td[data-row="${row}"][data-day="${day}"]`);
    }
    function paintRange(row, d1, d2, on=true) {
      const [from, to] = d1 <= d2 ? [d1, d2] : [d2, d1];
      for (let d = from; d <= to; d++) {
        if (fourChk.checked && d === 4) continue;
        const td = getCellTd(row, d);
        if (!td) continue;
        td.classList.toggle('paint-select', on);
      }
    }

    const fillState = { active:false, row:null, startDay:null, lastDay:null, value:"" };

    function startFill(row, day, value) {
      fillState.active = true;
      fillState.row = row;
      fillState.startDay = day;
      fillState.lastDay = day;
      fillState.value = value ?? "";
      paintRange(row, day, day, true);
    }
    function updateFill(day) {
      if (!fillState.active) return;
      paintRange(fillState.row, fillState.startDay, fillState.lastDay, false);
      fillState.lastDay = day;
      paintRange(fillState.row, fillState.startDay, fillState.lastDay, true);
    }
    async function endFill() {
      if (!fillState.active) return;
      const row = fillState.row;
      const d1  = Math.min(fillState.startDay, fillState.lastDay);
      const d2  = Math.max(fillState.startDay, fillState.lastDay);

      let updates = [];
      for (let d = d1; d <= d2; d++) {
        if (fourChk.checked && d === 4) continue;
        const inp = getCellInput(row, d);
        if (!inp) continue;
        inp.value = fillState.value;
        updates.push({ row, day:d, value: fillState.value });
      }
      await saveBatch(updates);
      applyColors();

      paintRange(row, d1, d2, false);
      fillState.active = false;
      fillState.row = null; fillState.startDay = null; fillState.lastDay = null; fillState.value = "";
    }

    function attachPaintFill() {
      const tds = document.querySelectorAll('#weekTable td');

      tds.forEach(td => {
        const row = Number(td.dataset.row);
        const day = Number(td.dataset.day);
        const inp = td.querySelector('input.cell');

        td.addEventListener('mousedown', (e) => {
          if (e.button !== 0 || !e.shiftKey) return;
          if (fourChk.checked && day === 4) return;
          e.preventDefault();
          const startValue = (inp?.value ?? "");
          startFill(row, day, startValue);
        });

        td.addEventListener('mouseenter', () => {
          if (fillState.active && row === fillState.row) {
            updateFill(day);
          }
        });
      });

      document.addEventListener('mouseup', () => { if (fillState.active) endFill(); });
      document.addEventListener('mouseleave', () => { if (fillState.active) endFill(); });
    }

    /* ---------- Standort/KW/Jahr Navigation ---------- */
    function navigate(standort, kw, year){
      const url = `/week?standort=${encodeURIComponent(standort)}&kw=${kw}&year=${year}`;
      window.location.href = url;
    }
    document.getElementById('locationSelect').onchange = ()=>{
      const loc = document.getElementById('locationSelect').value || CURRENT_LOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      navigate(loc, kw, yr);
    };
    document.getElementById('prevWeekBtn').onclick = ()=>{
      const loc = document.getElementById('locationSelect').value || CURRENT_LOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      const p   = (kw>1) ? {kw: kw-1, year: yr} : {kw: MAX_WEEKS, year: yr-1};
      navigate(loc, p.kw, p.year);
    };
    document.getElementById('nextWeekBtn').onclick = ()=>{
      const loc = document.getElementById('locationSelect').value || CURRENT_LOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      const n   = (kw<MAX_WEEKS) ? {kw: kw+1, year: yr} : {kw: 1, year: yr+1};
      navigate(loc, n.kw, n.year);
    };
    document.getElementById('goBtn').onclick = ()=>{
      const loc = document.getElementById('locationSelect').value || CURRENT_LOC;
      const kw  = parseInt(document.getElementById('kwSelect').value, 10);
      const yr  = parseInt(document.getElementById('yearSelect').value, 10);
      navigate(loc, kw, yr);
    };

    /* ---------- Init ---------- */
    attachDnD();
    attachPaintFill();
    applyColors();

  } catch (err) {
    console.error('Init-Fehler in week.html:', err);
    alert('Fehler beim Laden der Wochenansicht. Bitte Seite hart neu laden (Strg+F5).');
  }
});
</script>
{% endblock %}
