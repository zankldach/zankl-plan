<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wochenplanung Zankl Dach</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f4f6f8; }
header { background:#003a8f; color:white; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
nav { display:flex; gap:15px; }
nav a { color:white; text-decoration:none; font-weight:bold; }
section { padding:20px; }
h2 { margin-top:0; }
table { width:100%; border-collapse:collapse; background:white; margin-bottom:20px; }
th, td { border:1px solid #ddd; padding:6px; text-align:center; }
th { background:#eef2f6; }
td input { width:100%; padding:4px; box-sizing:border-box; }
button { padding:4px 8px; margin-left:4px; cursor:pointer; }
button.delete { background:#f44336; color:white; border:none; }
button.edit { background:#2196f3; color:white; border:none; }
.add-row { margin-top:10px; padding:6px 12px; background:#4caf50; color:white; border:none; cursor:pointer; }
#saveBtn { padding:6px 12px; background:#003a8f; color:white; border:none; cursor:pointer; }

/* Einfaches responsive Menü */
@media(max-width:600px){
    nav { flex-direction:column; gap:5px; }
}
</style>
</head>
<body>

<header>
    <strong>Zankl Dach – Wochenplanung</strong>
    <nav>
        <a href="/week?standort=engelbrechts">Engelbrechts</a>
        <a href="/week?standort=gross-gerungs">Groß Gerungs</a>
        <a href="/settings/employees">Mitarbeiter</a>
    </nav>
</header>

<section>
<h2>Wochenplanung – Standort: <span id="currentLocationLabel">{{ standort }}</span></h2>

<label for="locationSelect">Standort wechseln:</label>
<select id="locationSelect">
    <option value="engelbrechts" {% if standort=='engelbrechts' %}selected{% endif %}>Engelbrechts</option>
    <option value="gross-gerungs" {% if standort=='gross-gerungs' %}selected{% endif %}>Groß Gerungs</option>
</select>

<table id="weekTable">
    <thead>
        <tr>
            <th>Mitarbeiter / Tag</th>
            {% for day in days %}
            <th>{{ day.label }}<br>{{ day.date }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in grid %}
        <tr>
            <td>
                {% if employees[loop.index0] %}
                    {{ employees[loop.index0].name }}
                {% else %}
                    Unbenannt
                {% endif %}
            </td>
            {% for cell in row %}
            <td>
                <input type="text" value="{{ cell.text }}" data-row="{{ loop.parent.index0 }}" data-day="{{ loop.index0 }}">
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<button id="saveBtn">Speichern</button>
</section>

<script>
const locationSelect = document.getElementById('locationSelect');
const currentLocationLabel = document.getElementById('currentLocationLabel');
const saveBtn = document.getElementById('saveBtn');

locationSelect.onchange = () => {
    const loc = locationSelect.value;
    window.location.href = `/week?standort=${loc}&kw={{ kw }}&year={{ year }}`;
};

saveBtn.onclick = () => {
    const updates = [];
    document.querySelectorAll('#weekTable tbody input').forEach(input => {
        updates.push({
            row: parseInt(input.dataset.row),
            day: parseInt(input.dataset.day),
            value: input.value,
            kw: {{ kw }},
            year: {{ year }},
            standort: locationSelect.value
        });
    });

    updates.forEach(data => {
        fetch('/api/week/set-cell', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(data)
        }).then(res => res.json())
          .then(r => console.log('Gespeichert:', r))
          .catch(e => console.warn('Fehler:', e));
    });

    alert('Änderungen gespeichert!');
};
</script>

</body>
</html>
