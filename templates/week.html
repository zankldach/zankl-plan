{% extends "base.html" %}

{% block title %}Wochenplanung{% endblock %}

{% block head %}
<style>
table.week {
  width: 100%;
  border-collapse: collapse;
}
table.week th, table.week td {
  border: 1px solid #d1d5db;
  padding: 6px;
  vertical-align: top;
}
input.cell {
  width: 100%;
  border: none;
  background: transparent;
  outline: none;
  font-size: 0.95rem;
}

/* 4-Tage-Woche â€“ Freitag nur optisch sperren */
td.disabled-day {
  background: #eceff4 !important;
}
td.disabled-day input.cell {
  color: #64748b;
}

.hint {
  font-size: 0.7rem;
  color: #64748b;
}
</style>
{% endblock %}

{% block content %}
<h2>Wochenplanung KW {{ kw }} / {{ year }}</h2>

<label style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
  <input type="checkbox" id="fourDayWeek">
  4-Tage-Woche (Freitag gesperrt)
</label>

<table class="week" id="weekTable">
  <thead>
    <tr>
      <th>Mitarbeiter</th>
      <th>Mo</th>
      <th>Di</th>
      <th>Mi</th>
      <th>Do</th>
      <th>Fr</th>
    </tr>
  </thead>
  <tbody>
  {% for row in grid %}
    <tr data-emp="{{ row.emp_id }}">
      <td>{{ row.name }}</td>
      {% for d in range(5) %}
      <td data-day="{{ d }}">
        <input
          class="cell"
          value="{{ row.days[d] or '' }}"
          data-day="{{ d }}"
        >
        <div class="hint"></div>
      </td>
      {% endfor %}
    </tr>
  {% endfor %}
  </tbody>
</table>

<button id="saveBtn">Speichern</button>

<script>
const fourChk = document.getElementById("fourDayWeek");

/* UI nur optisch sperren */
function applyFourDayWeekUI(flag){
  document.querySelectorAll('#weekTable td[data-day="4"]').forEach(td=>{
    td.classList.toggle('disabled-day', flag);
    const hint = td.querySelector('.hint');
    if (hint) hint.textContent = flag ? "gesperrt" : "";
  });
}

fourChk.addEventListener("change", ()=>{
  applyFourDayWeekUI(fourChk.checked);
});

/* Initialzustand */
applyFourDayWeekUI(fourChk.checked);

/* Speichern */
document.getElementById("saveBtn").addEventListener("click", ()=>{
  let updates = [];

  document.querySelectorAll("tr[data-emp]").forEach(tr=>{
    const emp = tr.dataset.emp;
    tr.querySelectorAll("input.cell").forEach(inp=>{
      const day = Number(inp.dataset.day);

      /* Freitag bei 4-Tage-Woche NICHT speichern */
      if (fourChk.checked && day === 4) return;

      updates.push({
        emp_id: emp,
        day: day,
        value: inp.value
      });
    });
  });

  fetch("/week/save", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      four_day_week: fourChk.checked,
      updates: updates
    })
  })
  .then(r=>r.json())
  .then(()=>alert("Gespeichert"));
});
</script>
{% endblock %}
