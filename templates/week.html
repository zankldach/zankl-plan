
{% extends "base.html" %}
{% block title %}Wochenplanung Zankl Dach – KW {{ kw }} / {{ year }}{% endblock %}

{% block head %}
<style>
  .layout { display:grid; grid-template-columns: 1fr 320px; gap:12px; align-items:start; }
  header.page { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

  .toolbar { display:flex; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
  .toolbar .group { display:flex; gap:8px; align-items:center; }
  .toolbar select, .toolbar button, .toolbar input[type="checkbox"] { padding:6px 8px; font-size:14px; }
  .toolbar .badge { display:inline-block; padding:4px 8px; background:#eef2f6; border-radius:999px; font-size:12px; color:#334155; }

  #weekTable {
    width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed;
    background:#fff; border:1px solid #d9dee5; border-radius:8px; overflow:hidden;
    box-shadow:0 3px 12px rgba(0,0,0,0.06);
  }
  #weekTable thead th {
    position:sticky; top:0; z-index:3; background:#0b57d0; color:#fff; padding:8px 6px; font-weight:700;
    border-bottom:1px solid rgba(255,255,255,0.2); text-align:center;
  }
  #weekTable thead th:first-child,
  #weekTable tbody td:first-child {
    position:sticky; left:0; z-index:2; background:#f7f9fc; font-weight:600; width:180px; text-align:left;
  }
  #weekTable tbody td { border-top:1px solid #eef2f6; border-right:1px solid #eef2f6; padding:0 6px; height:54px; vertical-align:middle; }
  #weekTable tbody tr:nth-child(even) td:first-child { background:#f1f5fb; }
  #weekTable tbody tr:hover td { background:#fbfdff; }
  #weekTable textarea.cell {
    width:100%; height:46px; padding:4px 6px; border:none; background:transparent;
    text-align:center; font-size:13px; outline:none; resize:vertical; line-height:1.2;
  }
  #weekTable textarea.cell:focus { outline:2px solid #7db3ff; background:#fff; border-radius:6px; }

  .drag-over { outline:2px dashed #2196f3; outline-offset:-4px; background:#eef7ff !important; }
  .paint-select { outline:2px dashed #fb923c; outline-offset:-4px; background:#fff7ed !important; }

  /* Freitag (4‑Tage‑Woche) */
  td.cell-friday-locked { background:#e2e8f0 !important; }
  td.cell-friday-locked textarea.cell { color:#475569; }

  /* Sidebar Kleinbaustellen */
  .side { background:#fff; border:1px solid #d9dee5; border-radius:8px; box-shadow:0 3px 12px rgba(0,0,0,0.06); }
  .side header { background:#0b57d0; color:#fff; padding:8px 12px; font-weight:700; border-bottom:1px solid rgba(255,255,255,0.2); position:sticky; top:0; z-index:2; }
  .side .list { max-height:70vh; overflow-y:auto; padding:8px 12px; }
  .side .row { display:flex; align-items:center; gap:8px; margin-bottom:8px; position:relative; }
  .side .row .drag-handle { cursor:grab; user-select:none; }
  .side .row input.job {
    flex:1; padding:6px 8px; border:1px solid #d9dee5; border-radius:6px;
    opacity:1 !important; visibility:visible !important; pointer-events:auto !important;
    color:#111 !important; background:#fff !important;
  }

  /* Neu: Visuelle Markierung für ausgewählte (doppelt geklickte) Zelle */
  td.cell-selected {
    outline:2px solid #fb923c; /* orange */
    outline-offset:-4px;
    background:#fff7ed !important;
  }
</style>
{% endblock %}

{% block content %}
<header class="page">
  <strong style="font-size:18px;">Zankl Dach – Wochenplanung</strong>
</header>

<div class="toolbar">
  <div class="group">
    <button id="prevWeekBtn" title="Vorige Woche">←</button>
    <label for="kwSelect">KW:</label>
    <select id="kwSelect"></select>
    <label for="yearSelect">Jahr:</label>
    <select id="yearSelect"></select>
    <button id="nextWeekBtn" title="Nächste Woche">→</button>
    <span class="badge">KW {{ kw }} / {{ year }}</span>
  </div>
  <div class="group">
    <label for="fourDayChk">4‑Tage‑Woche:</label>
    <input type="checkbox" id="fourDayChk" {% if four_day_week %}checked{% endif %} />
  </div>
</div>

<div class="layout">
  <!-- Wochenplan -->
  <div class="plan-wrap">
    <table class="planner" id="weekTable">
      <thead>
        <tr>
          <th>Mitarbeiter / Tag</th>
          {% for day in days %}
            <th>{{ day.label }}<br><small>{{ day.date }}</small></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in grid %}
          {% set r = loop.index0 %}
          <tr>
            <td>
              {% if employees and employees|length > r and employees[r] %}
                {{ employees[r].name }}
              {% else %}Unbenannt{% endif %}
            </td>
            {% for cell in row %}
              {% set d = loop.index0 %}
              <td data-row="{{ r }}" data-day="{{ d }}" class="{% if four_day_week and d == 4 %}cell-friday-locked{% endif %}">
                <textarea class="cell" draggable="true" data-row="{{ r }}" data-day="{{ d }}" rows="2">{{ cell.text if cell and cell.text is defined else '' }}</textarea>
                {% if d == 4 %}<span class="hint"></span>{% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Sidebar: Kleinbaustellen -->
  <div>
    <div class="side">
      <header>Kleinbaustellen</header>
      <div class="list" id="kleinList">
        {% set list = small_jobs or [] %}
        {% for item in list %}
          {% set txt = (item if item is string else (item.text if item.text is defined else '')) %}
          <div class="row">
            <span class="drag-handle" title="Ziehen in Wochenzelle" draggable="true">⋮⋮</span>
            <input type="text" class="job" data-row="{{ loop.index0 }}" value="{{ txt }}" placeholder="">
          </div>
        {% endfor %}
        {% if (not list) or (list|length==0) %}
          <div class="row">
            <span class="drag-handle" title="Ziehen in Wochenzelle" draggable="true">⋮⋮</span>
            <input type="text" class="job" data-row="0" value="" placeholder="">
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    // --- Kontext ---
    const KW = parseInt('{{ kw }}', 10);
    const YEAR = parseInt('{{ year }}', 10);
    const CURLOC = "{{ (standort|string) }}";
    const MAX_WEEKS = 53;
    const FOUR_DAY = !!({{ 1 if four_day_week else 0 }});
    const PLAN_KEY = (loc, kw, year)=> `${loc}|${kw}|${year}`;
    const planKey = PLAN_KEY(CURLOC, KW, YEAR);

    const kwSel = document.getElementById('kwSelect');
    const yearSel = document.getElementById('yearSelect');
    const fourChk = document.getElementById('fourDayChk');

    // ===== KW/Jahr füllen =====
    (function initSelectors(){
      if (kwSel && kwSel.options.length === 0) {
        for (let w=1; w<=MAX_WEEKS; w++){
          const opt = document.createElement('option');
          opt.value = w; opt.textContent = w; if (w === KW) opt.selected = true;
          kwSel.appendChild(opt);
        }
      }
      if (yearSel && yearSel.options.length === 0) {
        [YEAR-1, YEAR, YEAR+1].forEach(y=>{
          const opt = document.createElement('option');
          opt.value = y; opt.textContent = y; if (y === YEAR) opt.selected = true;
          yearSel.appendChild(opt);
        });
      }
    })();

    // ===== 4‑Tage‑Woche UI =====
    function cacheFridayTexts(){
      const vals = Array.from(document.querySelectorAll('#weekTable td[data-day="4"] textarea.cell')).map(inp => inp.value || "");
      localStorage.setItem(`fridayCache:${planKey}`, JSON.stringify(vals));
    }
    function restoreFridayFromCache(){
      const raw = localStorage.getItem(`fridayCache:${planKey}`); if (!raw) return;
      const cache = JSON.parse(raw);
      document.querySelectorAll('#weekTable td[data-day="4"] textarea.cell').forEach((inp, idx)=>{
        if (!inp.value && cache && typeof cache[idx] === 'string') inp.value = cache[idx];
      });
    }
    function applyFourDayWeekUI(flag){
      document.querySelectorAll('#weekTable td[data-day="4"]').forEach(td=>{
        const ta = td.querySelector('textarea.cell');
        const hint = td.querySelector('.hint');
        if (flag) {
          td.classList.add('cell-friday-locked');
          if (ta) ta.readOnly = true;
          if (hint) hint.textContent = "";
        } else {
          td.classList.remove('cell-friday-locked');
          if (ta) ta.readOnly = false;
          if (hint) hint.textContent = "";
        }
      });
    }
    async function setFourDayWeek(flag){
      const payload = { year: parseInt(yearSel?.value ?? '{{ year }}',10),
                        kw: parseInt(kwSel?.value ?? '{{ kw }}',10),
                        standort: CURLOC, four_day_week: !!flag };
      try{
        const res = await fetch('/api/week/options', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if (!res.ok) console.warn('4‑Tage‑Woche speichern fehlgeschlagen', await res.text());
      }catch(e){ console.warn('Netz-/Serverfehler bei 4‑Tage‑Woche:', e); }
    }
    fourChk.addEventListener('change', async ()=>{
      const flag = fourChk.checked;
      cacheFridayTexts();
      applyFourDayWeekUI(flag);
      applyColors();
      await setFourDayWeek(flag);
    });
    applyFourDayWeekUI(FOUR_DAY);
    if (FOUR_DAY) restoreFridayFromCache();

    // ===== Farben =====
    const RESERVED_RED = new Set(["urlaub","krank","arzt","za","xxx","x","xx"]);
    const norm = s => (s||"").trim().toLowerCase().replace(/\s+/g, " ");
    function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
    function colorFor(text){
      const n = norm(text); if (!n) return null;
      if (RESERVED_RED.has(n)) return { bg:"hsla(0, 85%, 67%, 0.70)", border:"hsl(0, 82%, 42%)" };
      let h = hashCode(n) % 360;
      if (h <= 20 || h >= 340) h = (h + 40) % 360;
      const s=70, l=80;
      return { bg:`hsla(${h}, ${s}%, ${l}%, 0.65)`, border:`hsl(${h}, ${s}%, ${Math.max(40, l-25)}%)` };
    }
    function applyColors(){
      document.querySelectorAll('#weekTable textarea.cell').forEach(inp=>{
        const c = colorFor(inp.value);
        if (c){ inp.style.background=c.bg; inp.style.border=`1px solid ${c.border}`; inp.style.borderRadius='6px'; }
        else { inp.style.background='transparent'; inp.style.border='none'; }
      });
    }

    // ===== Speichern (Zellen) =====
    async function saveCell(row, day, value){
      if (Number(day) === 4) cacheFridayTexts();
      if (fourChk.checked && Number(day) === 4) return true;
      try{
        const res = await fetch('/api/week/set-cell',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            row:Number(row), day:Number(day), value: value ?? "",
            kw: parseInt(kwSel?.value ?? '{{ kw }}', 10),
            year: parseInt(yearSel?.value ?? '{{ year }}', 10),
            standort: CURLOC
          })
        });
        if (!res.ok){ console.warn('Save HTTP-Fehler:', res.status); return false; }
        const r = await res.json().catch(()=>({ok:true}));
        if(!r.ok){ console.warn('Save-Fehler:', r.error); return false; }
        return true;
      }catch(e){ console.warn('Netz-/Serverfehler:', e); return false; }
    }
    async function saveBatch(updates){
      cacheFridayTexts();
      if (fourChk.checked) updates = updates.filter(u => Number(u.day) !== 4);
      try{
        const res = await fetch('/api/week/batch',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            year: parseInt(yearSel?.value ?? '{{ year }}', 10),
            kw: parseInt(kwSel?.value ?? '{{ kw }}', 10),
            standort: CURLOC,
            updates
          })
        });
        if (!res.ok){ console.warn('Batch HTTP-Fehler:', res.status); return false; }
        const r = await res.json().catch(()=>({ok:true}));
        if(!r.ok){ console.warn('Batch-Fehler:', r.error); return false; }
        return true;
      }catch(e){ console.warn('Netz-/Serverfehler:', e); return false; }
    }

    // ===== Bereichs-Füllen (Shift + ziehen) =====
    const fillState = { active:false, row:null, startDay:null, lastDay:null, value:"" };
    function getCell(row, day){ return document.querySelector(`#weekTable textarea.cell[data-row="${row}"][data-day="${day}"]`); }
    function getTd(row, day){ return document.querySelector(`#weekTable td[data-row="${row}"][data-day="${day}"]`); }
    function paintRange(row, d1, d2, on=true){
      const [from,to] = d1<=d2 ? [d1,d2] : [d2,d1];
      for (let d=from; d<=to; d++){
        if (fourChk.checked && d===4) continue;
        const td = getTd(row, d); if (!td) continue;
        td.classList.toggle('paint-select', on);
      }
    }
    function startFill(row, day, value){ fillState.active=true; fillState.row=row; fillState.startDay=day; fillState.lastDay=day; fillState.value=value||""; paintRange(row, day, day, true); }
    function updateFill(day){ if (!fillState.active) return; paintRange(fillState.row, fillState.startDay, fillState.lastDay, false); fillState.lastDay=day; paintRange(fillState.row, fillState.startDay, fillState.lastDay, true); }
    async function endFill(){
      if (!fillState.active) return;
      const row = fillState.row;
      const d1 = Math.min(fillState.startDay, fillState.lastDay);
      const d2 = Math.max(fillState.startDay, fillState.lastDay);
      let updates = [];
      for (let d=d1; d<=d2; d++){
        if (fourChk.checked && d===4) continue;
        const ta = getCell(row, d); if (!ta) continue;
        ta.value = fillState.value;
        updates.push({ row, day:d, value: fillState.value });
      }
      await saveBatch(updates);
      applyColors();
      paintRange(row, d1, d2, false);
      fillState.active=false; fillState.row=null; fillState.startDay=null; fillState.lastDay=null; fillState.value="";
    }

    // ===== DnD & Eingabe-Events im Grid =====
    const inputs = document.querySelectorAll('#weekTable textarea.cell');
    const cells  = document.querySelectorAll('#weekTable td');

    // Copy/Move (nur Grid→Grid). Klein→Grid immer Copy.
    let DND_COPY = false;
    let DND_FROM = null; // 'grid' | 'klein' | null

    inputs.forEach(inp=>{
      inp.addEventListener('dragstart', e=>{
        if (e.shiftKey || fillState.active) { e.preventDefault(); return; }
        const payload = { source:'grid', row:Number(inp.dataset.row), day:Number(inp.dataset.day), value: inp.value || '' };
        const s = JSON.stringify(payload);
        try{ e.dataTransfer.setData('application/json', s); }catch(_){}
        try{ e.dataTransfer.setData('text/plain', s); }catch(_){}
        try{ e.dataTransfer.setData('text', s); }catch(_){}
        e.dataTransfer.effectAllowed = 'copyMove';
        inp.classList.add('dragging');
        DND_FROM = 'grid';
      });
      inp.addEventListener('dragend', ()=>{
        document.querySelectorAll('.drag-over').forEach(el=>el.classList.remove('drag-over'));
        document.querySelectorAll('.dragging').forEach(el=>el.classList.remove('dragging'));
        DND_FROM = null;
      });

      // Doppelklick: ganze Zelle "markieren"
      inp.addEventListener('dblclick', (ev)=>{
        const td = inp.closest('td');
        clearSelected();
        td.classList.add('cell-selected');
        SELECTED.row = Number(inp.dataset.row);
        SELECTED.day = Number(inp.dataset.day);
        // Fokus + gesamten Text selektieren
        inp.focus();
        inp.select();
      });

      // normale Eingabe-Events
      inp.addEventListener('blur', async ()=>{ await saveCell(inp.dataset.row, parseInt(inp.dataset.day,10), inp.value); applyColors(); });
      inp.addEventListener('keydown', async ev=>{
        if (ev.key === 'Enter' && !ev.shiftKey){
          ev.preventDefault();
          await saveCell(inp.dataset.row, parseInt(inp.dataset.day,10), inp.value);
          applyColors();
          const r=Number(inp.dataset.row), d=Number(inp.dataset.day);
          const next = document.querySelector(`textarea.cell[data-row="${r}"][data-day="${d+1}"]`);
          (next||inp).focus();
        }
      });
      inp.addEventListener('input', applyColors);
    });

    // Mousedown/Mouseenter für Paint-Select (Shift)
    document.querySelectorAll('#weekTable td').forEach(td=>{
      const row = Number(td.dataset.row), day = Number(td.dataset.day);
      const ta = td.querySelector('textarea.cell');

      td.addEventListener('mousedown', (e)=>{
        if (e.button !== 0) return;
        // Klick in andere Zelle hebt Selektion auf (außer bei Shift-Füllen)
        if (!e.shiftKey) { clearSelected(); }
        if (!e.shiftKey) return; // nur Shift startet das Paint-Select hier
        if (fourChk.checked && day === 4) return;
        e.preventDefault();
        const startValue = (ta?.value ?? "");
        startFill(row, day, startValue);
      });

      td.addEventListener('mouseenter', ()=>{ if (fillState.active && row === fillState.row) updateFill(day); });
    });
    document.addEventListener('mouseup', endFill);
    document.addEventListener('mouseleave', endFill);

    // Drop-Ziele
    cells.forEach(td=>{
      td.addEventListener('dragover', e=>{
        if (fillState.active) return;
        if (DND_FROM === 'klein') {
          e.dataTransfer.dropEffect = 'copy';
        } else {
          DND_COPY = !!(e.ctrlKey || e.metaKey);
          e.dataTransfer.dropEffect = DND_COPY ? 'copy' : 'move';
        }
        e.preventDefault();
        const targetDay = Number(td.dataset.day);
        if (fourChk.checked && targetDay === 4) return;
        td.classList.add('drag-over');
      });
      td.addEventListener('dragleave', ()=> td.classList.remove('drag-over'));
      td.addEventListener('drop', async e=>{
        td.classList.remove('drag-over');
        if (fillState.active) return;
        e.preventDefault();
        try{
          let dataStr =
            e.dataTransfer.getData('application/json') ||
            e.dataTransfer.getData('text/plain') ||
            e.dataTransfer.getData('text') || '';
          let payload = {};
          try { payload = JSON.parse(dataStr || '{}'); } catch(_) { payload = {}; }

          const targetRow = Number(td.dataset.row);
          const targetDay = Number(td.dataset.day);
          if (fourChk.checked && targetDay === 4) return;
          const tgt = td.querySelector('textarea.cell'); if (!tgt) return;

          // GRID → GRID
          if (payload && payload.source === 'grid'){
            const text  = (payload.value || '');
            const srcR  = Number(payload.row);
            const srcD  = Number(payload.day);

            tgt.value = text;
            await saveCell(targetRow, targetDay, text);
            applyColors();

            if (!DND_COPY && (srcR !== targetRow || srcD !== targetDay)) {
              const srcTa = document.querySelector(`#weekTable textarea.cell[data-row="${srcR}"][data-day="${srcD}"]`);
              if (srcTa) {
                srcTa.value = '';
                await saveCell(srcR, srcD, '');
                applyColors();
              }
            }
            return;
          }

          // KLEIN → GRID (immer Copy)
          if (payload && payload.source === 'klein'){
            const text = (payload.value || '').trim();
            tgt.value = text;
            await saveCell(targetRow, targetDay, text);
            applyColors();
            return;
          }
        }catch(err){ console.warn('Drop-Fehler:', err); }
      });
    });

    // ===== Navigation =====
    function navigate(kw, year){
      const url = `/week?standort=${encodeURIComponent(CURLOC)}&kw=${kw}&year=${year}`;
      window.location.href = url;
    }
    kwSel?.addEventListener('change', ()=> navigate(parseInt(kwSel.value,10), parseInt(yearSel.value,10)));
    yearSel?.addEventListener('change', ()=> navigate(parseInt(kwSel.value,10), parseInt(yearSel.value,10)));
    document.getElementById('prevWeekBtn').onclick = ()=>{
      const kw = parseInt(kwSel?.value ?? '{{ kw }}',10);
      const yr = parseInt(yearSel?.value ?? '{{ year }}',10);
      const p = (kw>1) ? {kw: kw-1, year: yr} : {kw: MAX_WEEKS, year: yr-1};
      navigate(p.kw, p.year);
    };
    document.getElementById('nextWeekBtn').onclick = ()=>{
      const kw = parseInt(kwSel?.value ?? '{{ kw }}',10);
      const yr = parseInt(yearSel?.value ?? '{{ year }}',10);
      const n = (kw<MAX_WEEKS) ? {kw: kw+1, year: yr} : {kw: 1, year: yr+1};
      navigate(n.kw, n.year);
    };

    // ===== Farben initial =====
    applyColors();

    /* ===== Kleinbaustellen speichern ===== */
    (function () {
      const JOB_SELECTOR = '#kleinList input.job';
      function debounce(fn, wait) { let t=null; return function(...a){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait);} }
      async function saveKlein(rowIndex, text) {
        try {
          const payload = { standort: CURLOC, row_index: Number(rowIndex||0), text: (text||'').trim() };
          const res = await fetch('/api/klein/set', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if (!res.ok) console.warn('Kleinbaustellen-HTTP-Fehler:', res.status);
        } catch (e) { console.warn('Netz-/Serverfehler Kleinbaustellen:', e); }
      }
      function wireKleinInputs(root=document){
        const inputs = root.querySelectorAll(JOB_SELECTOR);
        const debouncedSave = debounce((inp)=>{ const idx = inp.getAttribute('data-row') ?? inp.dataset.row ?? '0'; saveKlein(idx, inp.value); }, 400);
        inputs.forEach(inp=>{
          inp.addEventListener('blur', ()=>{ const idx = inp.getAttribute('data-row') ?? inp.dataset.row ?? '0'; saveKlein(idx, inp.value); });
          inp.addEventListener('keydown', (ev)=>{ if (ev.key==='Enter' && !ev.shiftKey){ ev.preventDefault(); const idx = inp.getAttribute('data-row') ?? inp.dataset.row ?? '0'; saveKlein(idx, inp.value);} });
          inp.addEventListener('input', ()=> debouncedSave(inp));
        });
      }
      wireKleinInputs(document);
    })();

    /* ===== Klein → Grid (immer Copy) ===== */
    (function () {
      const LIST = document.getElementById('kleinList');
      if (!LIST) return;

      function setDragPayload(dt, obj){
        const s = JSON.stringify(obj || {});
        try{ dt.setData('application/json', s); }catch(_){}
        try{ dt.setData('text/plain', s); }catch(_){}
        try{ dt.setData('text', s); }catch(_){}
      }

      LIST.querySelectorAll('.row .drag-handle').forEach(handle=>{
        handle.setAttribute('draggable','true');
        handle.addEventListener('dragstart', (e)=>{
          const rowEl = handle.closest('.row');
          const inp = rowEl?.querySelector('input.job');
          const value = (inp?.value || '').trim();
          setDragPayload(e.dataTransfer, { source:'klein', value });
          e.dataTransfer.effectAllowed = 'copy';
          handle.classList.add('dragging');
          DND_FROM = 'klein';
        });
        handle.addEventListener('dragend', ()=> {
          handle.classList.remove('dragging');
          DND_FROM = null;
        });
      });

      LIST.querySelectorAll('input.job').forEach(inp=>{
        inp.setAttribute('draggable','true');
        inp.addEventListener('dragstart', (e)=>{
          const value = (inp.value || '').trim();
          setDragPayload(e.dataTransfer, { source:'klein', value });
          e.dataTransfer.effectAllowed = 'copy';
          inp.classList.add('dragging');
          DND_FROM = 'klein';
        });
        inp.addEventListener('dragend', ()=> {
          inp.classList.remove('dragging');
          DND_FROM = null;
        });
      });
    })();

    /* ===== Neu: Doppelklick markieren & Entf/Backspace leeren ===== */
    let SELECTED = { row: null, day: null };
    function clearSelected(){
      document.querySelectorAll('#weekTable td.cell-selected').forEach(td => td.classList.remove('cell-selected'));
      SELECTED = { row:null, day:null };
    }
    document.addEventListener('keydown', async (ev)=>{
      // wenn eine Zelle selektiert ist: Delete/Backspace leeren, Esc aufheben
      if (SELECTED.row === null || SELECTED.day === null) return;

      if (ev.key === 'Delete' || ev.key === 'Backspace'){
        ev.preventDefault();
        // Freitagsschutz
        if (fourChk.checked && Number(SELECTED.day) === 4) return;
        const ta = document.querySelector(`#weekTable textarea.cell[data-row="${SELECTED.row}"][data-day="${SELECTED.day}"]`);
        if (ta){
          ta.value = '';
          await saveCell(SELECTED.row, SELECTED.day, '');
          applyColors();
        }
        clearSelected();
      } else if (ev.key === 'Escape'){
        ev.preventDefault();
        clearSelected();
      }
    });

  } catch (err) {
    console.error('Init-Fehler in week.html:', err);
    alert('Fehler beim Laden der Wochenansicht. Bitte Seite hart neu laden (Strg+F5).');
  }
});
</script>
{% endblock %}
