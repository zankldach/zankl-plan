
{% extends "base.html" %}
{% block title %}Wochenplanung Zankl Dach – KW {{ kw }} / {{ year }}{% endblock %}

{% block head %}
<style>
  /* Layout: Wochenplan links, Kleinbaustellen rechts */
  .layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 12px;
    align-items: start;
  }

  header.page { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

  /* Toolbar */
  .toolbar { display:flex; gap:16px; align-items:center; flex-wrap: wrap; margin-bottom:8px; }
  .toolbar .group { display:flex; gap:8px; align-items:center; }
  .toolbar label { font-weight: 600; }
  .toolbar select, .toolbar button, .toolbar input[type="checkbox"] { padding: 6px 8px; font-size: 14px; }
  .toolbar .badge { display:inline-block; padding:4px 8px; background:#eef2f6; border-radius:999px; font-size:12px; color:#334155; }

  /* Wochenplan Tabelle */
  .plan-wrap { margin-top: 0; }
  table.planner {
    width: 100%;
    border-collapse: separate; border-spacing: 0; table-layout: fixed;
    background: #fff; border: 1px solid #d9dee5; border-radius: 8px; overflow: hidden;
    box-shadow: 0 3px 12px rgba(0,0,0,0.06);
  }
  .planner thead th {
    position: sticky; top: 0; z-index: 3;
    background: #0b57d0; color: #fff; padding: 8px 6px; font-weight: 700;
    border-bottom: 1px solid rgba(255,255,255,0.2);
  }
  .planner thead th:first-child,
  .planner tbody td:first-child {
    position: sticky; left: 0; z-index: 2;
    background: #f7f9fc; font-weight: 600; width: 180px; text-align: left;
  }
  .planner tbody td { border-top: 1px solid #eef2f6; border-right: 1px solid #eef2f6; padding: 0; height: 42px; }
  .planner tbody tr:nth-child(even) td:first-child { background: #f1f5fb; }
  .planner tbody tr:hover td { background: #fbfdff; }

  .planner input.cell { width: 100%; height: 42px; padding: 4px 6px; border: none; background: transparent; text-align: center; font-size: 13px; outline: none; }
  .planner input.cell:focus { outline: 2px solid #7db3ff; background: #fff; }

  .drag-over { outline: 2px dashed #2196f3; outline-offset: -4px; background: #eef7ff !important; }
  .dragging { opacity: .6; }

  td.paint-select { outline: 2px dashed #fb923c; outline-offset: -4px; background: #fff7ed !important; }

  td.disabled-day { background: #eceff4 !important; }
  td.disabled-day input.cell { pointer-events: none; color: #64748b; }
  td.disabled-day .hint { position:absolute; top:4px; left:4px; font-size:10px; color:#64748b; }

  .is-empty { background: transparent !important; }

  /* Kleinbaustellen Panel */
  .side {
    background: #fff;
    border: 1px solid #d9dee5;
    border-radius: 8px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.06);
  }
  .side header {
    background: #0b57d0;
    color: #fff;
    padding: 8px 12px;
    font-weight: 700;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .side .list {
    max-height: 500px;
    overflow-y: auto;
    padding: 8px 12px;
  }
  .side .row {
    display:flex; align-items:center; gap:8px;
    margin-bottom:8px;
  }
  .side .row input.job {
    flex:1; padding:6px 8px; border:1px solid #d9dee5; border-radius:6px;
  }
  .side .row input.job:focus { outline: 2px solid #7db3ff; }
  .job.selected { outline: 2px solid #f87171; background: #fee2e2; }
</style>
{% endblock %}

{% block content %}
<header class="page">
  <strong style="font-size:18px;">Zankl Dach – Wochenplanung</strong>
</header>

<div class="toolbar">
  <div class="group">
    <label for="locationSelect">Standort:</label>
    <select id="locationSelect">
      <option value="engelbrechts" {% if standort=='engelbrechts' %}selected{% endif %}>Engelbrechts</option>
      <option value="gross-gerungs" {% if standort=='gross-gerungs' %}selected{% endif %}>Groß Gerungs</option>
    </select>
  </div>

  <div class="group">
    <button id="prevWeekBtn">←</button>
    <label for="kwSelect">KW:</label>
    <select id="kwSelect"></select>
    <label for="yearSelect">Jahr:</label>
    <select id="yearSelect"></select>
    <button id="nextWeekBtn">→</button>
    <button id="goBtn">Öffnen</button>
  </div>

  <div class="group">
    <label for="fourDayChk">4‑Tage‑Woche:</label>
    <input type="checkbox" id="fourDayChk" {% if four_day_week %}checked{% endif %} />
    <span class="badge">KW {{ kw }} / {{ year }}</span>
  </div>
</div>

<div class="layout">
  <!-- Wochenplan -->
  <div class="plan-wrap">
    <table class="planner" id="weekTable">
      <thead>
        <tr>
          <th>Mitarbeiter / Tag</th>
          {% for day in days %}
            <th>{{ day.label }}<br><small>{{ day.date }}</small></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in grid %}
          {% set row_index = loop.index0 %}
          <tr>
            <td>
              {% if employees and employees|length > row_index and employees[row_index] %}
                {{ employees[row_index].name }}
              {% else %}
                Unbenannt
              {% endif %}
            </td>
            {% for cell in row %}
              {% set day_index = loop.index0 %}
              <td data-row="{{ row_index }}" data-day="{{ day_index }}">
                <input class="cell" draggable="true"
                       value="{{ cell.text if cell and cell.text is defined else '' }}"
                       data-row="{{ row_index }}" data-day="{{ day_index }}">
                {% if day_index == 4 %}
                  <span class="hint"></span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div style="margin-top:10px;">
      <button id="saveAllBtn">Alles speichern</button>
    </div>
  </div>

  <!-- Kleinbaustellen -->
  <aside class="side">
    <header>Kleinbaustellen</header>
    <div class="list" id="smallJobsList">
      {% for sj in small_jobs %}
        <div class="row" data-row="{{ sj.row_index }}">
          <input class="job" type="text" draggable="true"
                 value="{{ sj.text }}"
                 data-row="{{ sj.row_index }}">
        </div>
      {% endfor %}
    </div>
  </aside>
</div>
{% endblock %}

{% block scripts %}
<script>
  const KW = parseInt('{{ kw }}', 10);
  const YEAR = parseInt('{{ year }}', 10);
  const CURRENT_LOC = "{{ standort|e }}";
  const FOUR_DAY_WEEK = {{ 1 if four_day_week else 0 }} === 1;

  /* Navigation */
  function initSelectors(){
    const kwSel = document.getElementById('kwSelect');
    const yearSel = document.getElementById('yearSelect');
    for (let w=1; w<=53; w++){
      const opt = document.createElement('option');
      opt.value = w; opt.textContent = w;
      if (w === KW) opt.selected = true;
      kwSel.appendChild(opt);
    }
    [YEAR-1,YEAR,YEAR+1].forEach(y=>{
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      if (y === YEAR) opt.selected = true;
      yearSel.appendChild(opt);
    });
  }
  initSelectors();

  /* Kleinbaustellen: Doppelklick + Entf */
  async function saveSmallJob(row,text){
    await fetch('/api/klein/set',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({row_index:Number(row),text:text})
    });
  }
  function bindJobInput(input){
    input.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain',JSON.stringify({source:'klein',value:input.value}));
    });
    input.addEventListener('dblclick',()=>{
      document.querySelectorAll('.job').forEach(el=>el.classList.remove('selected'));
      input.classList.add('selected');
    });
    input.addEventListener('keydown',async ev=>{
      if(ev.key==='Delete'){
        input.value=""; await saveSmallJob(input.dataset.row,"");
      }
    });
    input.addEventListener('blur',async()=>await saveSmallJob(input.dataset.row,input.value));
  }
  document.querySelectorAll('.job').forEach(bindJobInput);
</script>
{% endblock %}
