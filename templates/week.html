<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wochenplanung</title>
<link rel="stylesheet" href="/static/style.v2.css?v=4">
<script src="/static/app.js?v=2"></script>
<style>
  table { width: 100%; table-layout: fixed; }
  th, td { text-align: center; border: 1px solid #ccc; }
  td.job-cell { cursor: pointer; user-select: none; }
</style>
</head>
<body>
<h1>Wochenplanung KW {{ kw }} / {{ year }}</h1>

<table id="week-table">
  <thead>
    <tr>
      <th>Mitarbeiter</th>
      {% for day in days %}
        <th>{{ day.label }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for r, employee in enumerate(employees) %}
      <tr data-row="{{ r }}">
        <td contenteditable="true" class="employee-name">{{ employee.name }}</td>
        {% for d in range(workdays) %}
          {% set cell = grid[r][d] %}
          <td class="job-cell" data-row="{{ r }}" data-day="{{ d }}" style="background-color: {{ cell.color or '#fff' }}">
            {{ cell.title or 'frei' }}
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pop-up für Jobs -->
<div id="job-popup" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:5px; z-index:1000;">
  <ul id="job-list">
    {% for job in jobs|sort(attribute='title') %}
      <li data-job-id="{{ job.id }}" data-color="{{ job.color or '#eee' }}">{{ job.title }}</li>
    {% endfor %}
  </ul>
</div>

<script>
const jobCells = document.querySelectorAll('.job-cell');
const popup = document.getElementById('job-popup');
let currentCell = null;

jobCells.forEach(cell => {
  cell.addEventListener('click', e => {
    currentCell = e.target;
    const rect = currentCell.getBoundingClientRect();
    popup.style.top = rect.bottom + "px";
    popup.style.left = rect.left + "px";
    popup.style.display = "block";
  });
});

// Job auswählen
document.querySelectorAll('#job-list li').forEach(li => {
  li.addEventListener('click', e => {
    const jobId = li.dataset.jobId;
    const color = li.dataset.color;
    const title = li.textContent;

    currentCell.textContent = title;
    currentCell.style.backgroundColor = color;

    // AJAX: speichern
    const row = currentCell.dataset.row;
    const day = currentCell.dataset.day;
    const weekPlanId = {{ week_plan_id }};
    fetch('/api/week/set-cell', {
      method: 'POST',
      body: new URLSearchParams({ week_plan_id: weekPlanId, row_index: row, day_index: day, job_id: jobId })
    });

    popup.style.display = 'none';
  });
});

// Klick außerhalb schließt das Pop-up
document.addEventListener('click', e => {
  if (!popup.contains(e.target) && !e.target.classList.contains('job-cell')) {
    popup.style.display = 'none';
  }
});
</script>
</body>
</html>
