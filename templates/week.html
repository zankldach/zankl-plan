{% extends "base.html" %}
{% block title %}Wochenplanung Zankl Dach – KW {{ kw }} / {{ year }}{% endblock %}

{% block content %}
<style>
.layout { display:grid; grid-template-columns:1fr 320px; gap:12px; }
header.page { display:flex; justify-content:space-between; margin-bottom:10px; }

table.planner {
  width:100%; border-collapse:separate; border-spacing:0;
  background:#fff; border:1px solid #d9dee5; border-radius:8px;
}
.planner th {
  background:#0b57d0; color:#fff; padding:6px;
}
.planner td {
  border-top:1px solid #eef2f6;
  border-right:1px solid #eef2f6;
  padding:0; height:40px;
}
.planner input.cell {
  width:100%; height:100%;
  border:none; background:transparent;
  text-align:center; outline:none;
}
.planner input.cell:focus {
  background:#fff;
  outline:2px solid #7db3ff;
}

td.disabled-day { background:#eceff4; }
td.disabled-day input { color:#64748b; }

.drag-over { outline:2px dashed #2196f3; background:#eef7ff !important; }

.wk-sidebar {
  background:#fff; border:1px solid #d9dee5; border-radius:8px;
  padding:8px;
}
.sj-row { display:flex; margin-bottom:6px; }
.sj-input {
  width:100%; padding:6px;
  border:1px solid #bbb; border-radius:4px;
}
</style>

<header class="page">
  <strong>Zankl Dach – Wochenplanung KW {{ kw }} / {{ year }}</strong>
</header>

<div class="layout">
  <!-- Wochenplan -->
  <table class="planner" id="weekTable">
    <thead>
      <tr>
        <th>Mitarbeiter</th>
        {% for d in days %}
          <th>{{ d.label }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in grid %}
        {% set r = loop.index0 %}
        <tr>
          <td>{{ employees[r].name if employees and employees|length>r else "—" }}</td>
          {% for cell in row %}
            {% set d = loop.index0 %}
            <td data-row="{{ r }}" data-day="{{ d }}">
              <input class="cell"
                     data-row="{{ r }}"
                     data-day="{{ d }}"
                     value="{{ cell.text if cell }}">
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Kleinbaustellen -->
  <aside class="wk-sidebar">
    <h3>Kleinbaustellen</h3>
    <div id="sj-list">
      {% for s in small_jobs %}
        <div class="sj-row">
          <input class="sj-input" value="{{ s.text or '' }}" draggable="true">
        </div>
      {% endfor %}
      {% if small_jobs|length == 0 %}
        <div class="sj-row">
          <input class="sj-input" value="" draggable="true">
        </div>
      {% endif %}
    </div>
  </aside>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

const KW={{kw}}, YEAR={{year}};
const STANDORT="{{standort}}";
const fourDay={{1 if four_day_week else 0}};

async function saveCell(row,day,value){
  if(fourDay && day===4) return;
  await fetch('/api/week/set-cell',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({row,day,value,kw:KW,year:YEAR,standort:STANDORT})
  });
}

/* ---------------- Farben ---------------- */
function applyColors(){
  document.querySelectorAll('input.cell').forEach(i=>{
    if(i.value.trim()){
      i.style.background='#e0f2fe';
      i.style.borderRadius='6px';
    }else{
      i.style.background='transparent';
    }
  });
}

/* ---------------- Grid DnD ---------------- */
let dragData=null;

document.querySelectorAll('input.cell').forEach(inp=>{
  inp.addEventListener('dragstart',e=>{
    dragData={
      source:'grid',
      row:+inp.dataset.row,
      day:+inp.dataset.day,
      value:inp.value
    };
  });
  inp.addEventListener('blur',()=>{
    saveCell(+inp.dataset.row,+inp.dataset.day,inp.value);
    applyColors();
  });
});

/* ---------------- Drop Targets ---------------- */
document.querySelectorAll('#weekTable td').forEach(td=>{
  td.addEventListener('dragover',e=>e.preventDefault());

  td.addEventListener('drop',async e=>{
    e.preventDefault();
    const row=+td.dataset.row, day=+td.dataset.day;
    if(fourDay && day===4) return;
    const inp=td.querySelector('input.cell');

    // Sidebar → Grid
    if(!dragData){
      const text=e.dataTransfer.getData('text/plain').trim();
      if(!text) return;
      inp.value=text;
      await saveCell(row,day,text);
      applyColors();
      return;
    }

    // Grid → Grid
    if(dragData.source==='grid'){
      inp.value=dragData.value;
      await saveCell(row,day,dragData.value);
      if(!(e.ctrlKey||e.metaKey)){
        const src=document.querySelector(
          `input.cell[data-row="${dragData.row}"][data-day="${dragData.day}"]`
        );
        if(src){ src.value=""; await saveCell(dragData.row,dragData.day,""); }
      }
      applyColors();
    }
  });
});

/* ---------------- Sidebar Drag ---------------- */
document.querySelectorAll('.sj-input').forEach(inp=>{
  inp.addEventListener('dragstart',e=>{
    e.dataTransfer.setData('text/plain',inp.value||"");
  });
});

applyColors();
});
</script>
{% endblock %}
