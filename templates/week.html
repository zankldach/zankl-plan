{% extends "base.html" %}

{% block title %}Zankl Plan – Wochenplanung{% endblock %}

{% block content %}
<h2>Wochenansicht – KW {{ kw }} / {{ year }}</h2>

<!-- Standorte -->
<div class="standorte">
    {% for s in standorte %}
        <a href="/week?standort_id={{ s.id }}&kw={{ kw }}&year={{ year }}"
           class="{% if s.id == standort_id %}active{% endif %}">
            {{ s.name }}
        </a>
    {% endfor %}
</div>

<!-- Steuerung -->
<form action="/week" method="get" class="week-form">
    <input type="hidden" name="standort_id" value="{{ standort_id }}">
    <label>KW: <input type="number" name="kw" value="{{ kw }}" min="1" max="53"></label>
    <label>Jahr: <input type="number" name="year" value="{{ year }}"></label>
    <button type="submit">Anzeigen</button>
</form>

<hr>

<!-- GRID -->
<table class="week-grid" border="1" cellpadding="6">
    <thead>
        <tr>
            <th>Zeile</th>
            {% for day in days %}
                <th>{{ day.label }}<br><small>{{ day.date }}</small></th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for r in range(employee_lines) %}
            <tr>
                <td>{{ r + 1 }}</td>
                {% for d in range(workdays) %}
                    {% set cell = grid[r][d] %}
                    <td class="cell" data-row="{{ r }}" data-day="{{ d }}" 
                        {% if cell and cell.color %}style="background-color: {{ cell.color }}"{% endif %}>
                        {% if cell and cell.title %}
                            <strong>{{ cell.title }}</strong><br>
                            <small>{{ cell.customer_name }}</small>
                        {% else %}
                            frei
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Auswahl Job -->
<select id="job-select" style="display:none;">
    <option value="">frei</option>
    {% for job in jobs %}
        <option value="{{ job.id }}">{{ job.title }} ({{ job.customer_name }})</option>
    {% endfor %}
</select>

<script>
document.querySelectorAll('.cell').forEach(cell => {
    cell.addEventListener('click', async () => {
        const row = cell.dataset.row;
        const day = cell.dataset.day;
        const jobId = prompt("Job-ID eingeben oder leer für frei:", "");

        if (jobId !== null) {
            const formData = new FormData();
            formData.append('week_plan_id', {{ week_plan_id }});
            formData.append('row_index', row);
            formData.append('day_index', day);
            formData.append('job_id', jobId || '');

            const res = await fetch("/api/week/set-cell", {
                method: "POST",
                body: formData
            });

            if (res.ok) location.reload();
            else alert("Fehler beim Setzen der Zelle");
        }
    });
});
</script>

{% endblock %}
