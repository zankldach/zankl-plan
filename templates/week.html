<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Zankl Plan – Wochenübersicht</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f4f6f8;
}

header {
    background: #003a8f;
    color: white;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

select {
    padding: 5px;
    font-size: 14px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
    min-width: 110px;
}

th {
    background: #eef2f6;
}

td input {
    width: 100%;
    border: none;
    background: transparent;
    text-align: center;
    font-size: 14px;
}
</style>
</head>

<body>

<header>
    <strong>Wochenplanung – Engelbrechts</strong>
    <div>
        KW:
        <select id="kw">
            {% for i in range(1,54) %}
                <option value="{{ i }}" {% if i == kw %}selected{% endif %}>{{ i }}</option>
            {% endfor %}
        </select>
        Jahr:
        <select id="year">
            {% for y in range(year-1, year+3) %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
    </div>
</header>

<table id="weekTable">
    <thead>
        <tr>
            <th>Mitarbeiter</th>
            {% for d in days %}
                <th>{{ d.label }}<br><small>{{ d.date }}</small></th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in grid %}
        <tr>
            <th>Mitarbeiter {{ loop.index }}</th>
            {% for cell in row %}
            <td>
                <input
                    value="{{ cell.text }}"
                    data-row="{{ loop.parent.index0 }}"
                    data-day="{{ loop.index0 }}"
                >
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
/* ---------- Farben ---------- */
const SPECIAL_RED = ['urlaub','krank','za','xxx'];
const colors = {};
const palette = [
    '#d1e7ff','#ffe0b2','#dcedc8','#f8bbd0',
    '#e1bee7','#c8e6c9','#fff9c4','#b2ebf2'
];
let colorIndex = 0;
let dragValue = null;

/* ---------- KW & Jahr ---------- */
const kwSelect = document.getElementById('kw');
const yearSelect = document.getElementById('year');

kwSelect.onchange = yearSelect.onchange = () => {
    location.href = `?kw=${kwSelect.value}&year=${yearSelect.value}`;
};

/* ---------- Initiale Farben setzen ---------- */
document.querySelectorAll('td input').forEach(input => {
    applyColor(input.parentElement, input.value);
});

/* ---------- Events ---------- */
document.querySelectorAll('td input').forEach(input => {

    input.oninput = () => applyColor(input.parentElement, input.value);

    input.onchange = () => saveCell(input);

    input.onmousedown = () => dragValue = input.value;

    input.onmouseover = () => {
        if (dragValue !== null) {
            input.value = dragValue;
            applyColor(input.parentElement, dragValue);
            saveCell(input);
        }
    };

    input.onmouseup = () => dragValue = null;
});

/* ---------- Farben ---------- */
function applyColor(td, value) {
    if (!value) {
        td.style.background = '';
        return;
    }

    const v = value.toLowerCase();

    if (SPECIAL_RED.includes(v)) {
        td.style.background = '#f28b82';
        return;
    }

    if (!colors[v]) {
        colors[v] = palette[colorIndex % palette.length];
        colorIndex++;
    }

    td.style.background = colors[v];
}

/* ---------- Speichern ---------- */
async function saveCell(input) {
    await fetch('/api/week/set-cell', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({
            week_plan_id: {{ week_plan_id }},
            row_index: input.dataset.row,
            day_index: input.dataset.day,
            text: input.value
        })
    });
}
</script>

</body>
</html>
