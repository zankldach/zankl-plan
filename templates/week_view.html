{% extends "base.html" %}
{% block title %}Wochenübersicht Zankl Dach – KW {{ kw }} / {{ year }}{% endblock %}

{% block head %}
<style>
  .layout { display:grid; grid-template-columns: 1fr 320px; gap:12px; align-items:start; }
  header.page { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }

  #weekTable {
    width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed;
    background:#fff; border:1px solid #d9dee5; border-radius:8px; overflow:hidden;
    box-shadow:0 3px 12px rgba(0,0,0,0.06);
  }
  #weekTable thead th {
    position:sticky; top:0; z-index:3; background:#0b57d0; color:#fff; padding:8px 6px; font-weight:700;
    border-bottom:1px solid rgba(255,255,255,0.2); text-align:center;
  }
  #weekTable thead th:first-child,
  #weekTable tbody td:first-child {
    position:sticky; left:0; z-index:2; background:#f7f9fc; font-weight:600; width:180px; text-align:left;
  }
  #weekTable tbody td { border-top:1px solid #eef2f6; border-right:1px solid #eef2f6; padding:0 6px; height:54px; vertical-align:middle; }
  #weekTable tbody tr:nth-child(even) td:first-child { background:#f1f5fb; }
  #weekTable tbody tr:hover td { background:#fbfdff; }

  #weekTable textarea.cell {
    width:100%; height:46px; padding:4px 6px; border:none; background:transparent;
    text-align:center; font-size:13px; outline:none; resize:none; line-height:1.2;
    color:#0f172a;
  }
  #weekTable textarea.cell:focus { outline:none; }

  /* Freitag in 4-Tage-Woche */
  .cell-friday-locked textarea.cell { color:#64748b; }

  /* Sidebar: Kleinbaustellen */
  .side { background:#fff; border:1px solid #d9dee5; border-radius:8px; box-shadow:0 3px 12px rgba(0,0,0,0.06); }
  .side header { background:#0b57d0; color:#fff; padding:8px 12px; font-weight:700; border-bottom:1px solid rgba(255,255,255,0.2); position:sticky; top:0; z-index:2; }
  .side .list { max-height:70vh; overflow-y:auto; padding:8px 12px; }
  .side .row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
  .side .row input.job {
    flex:1; padding:6px 8px; border:1px solid #d9dee5; border-radius:6px; background:#f8fafc; color:#0f172a;
    pointer-events:none; /* Keine Bearbeitung */
  }
</style>
{% endblock %}

{% block content %}
<header class="page">
  <strong style="font-size:18px;">Zankl Dach – Wochenübersicht</strong>
</header>

<div class="layout">
  <!-- Wochenplan -->
  <div class="plan-wrap">
    <table class="planner" id="weekTable">
      <thead>
        <tr>
          <th>Mitarbeiter / Tag</th>
          {% for day in days %}
            <th>{{ day.label }}<br><small>{{ day.date }}</small></th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in grid %}
          {% set r = loop.index0 %}
          <tr>
            <td>
              {% if employees and employees|length > r and employees[r] %}
                {{ employees[r].name }}
              {% else %}Unbenannt{% endif %}
            </td>
            {% for cell in row %}
              {% set d = loop.index0 %}
              <td data-row="{{ r }}" data-day="{{ d }}" class="{% if four_day_week and d==4 %}cell-friday-locked{% endif %}">
                <textarea class="cell" readonly rows="2">{{ cell.text if cell and cell.text is defined else '' }}</textarea>
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Sidebar: Kleinbaustellen -->
  <div>
    <div class="side">
      <header>Kleinbaustellen</header>
      <div class="list">
        {% for item in small_jobs or [] %}
          {% set txt = (item if item is string else (item.text if item.text is defined else '')) %}
          <div class="row">
            <input type="text" class="job" value="{{ txt }}" readonly />
          </div>
        {% endfor %}
        {% if not small_jobs or small_jobs|length==0 %}
          <div class="row">
            <input type="text" class="job" value="" readonly />
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // 4-Tage-Woche: Freitag grau markieren
  const fourDay = {{ 1 if four_day_week else 0 }};
  if(fourDay){
    document.querySelectorAll('#weekTable td[data-day="4"]').forEach(td=>{
      td.classList.add('cell-friday-locked');
    });
  }
});
</script>
{% endblock %}
