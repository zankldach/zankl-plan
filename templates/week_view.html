# src/routes/week_view.py

from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse
from jinja2 import Template
from utils import get_year_kw  # Funktion zum Normalisieren von Jahr/KW

router = APIRouter()

# Dummy-Daten f√ºr Testzwecke
employees = [
    {"name": "Max Mustermann"},
    {"name": "Anna Beispiel"},
]

cells = {
    (0, 0): "Projekt A",
    (0, 1): "Projekt B",
    (1, 0): "Urlaub",
}

four_day_week = True  # Beispiel: kann aus DB oder Settings kommen

@router.get("/view/week", response_class=HTMLResponse)
async def view_week(request: Request, standort: str, year: int | None = None, kw: int | None = None):
    # üîß Jahr und KW korrekt holen
    year, kw = get_year_kw(year, kw)

    # HTML-Template direkt hier (alternativ als separate Datei speichern)
    template_str = """
    {% extends "base.html" %}
    {% block title %}View ¬∑ {{ standort|capitalize }} ¬∑ KW {{ kw }}{% endblock %}

    {% block content %}
    <h1>
      Wochenplan ¬∑ {{ standort|capitalize }}
      <small style="color:#64748b;">KW {{ kw }} / {{ year }}</small>
    </h1>

    <table id="weekTable" class="planner">
      <thead>
        <tr>
          <th>Mitarbeiter</th>
          <th>Mo</th>
          <th>Di</th>
          <th>Mi</th>
          <th>Do</th>
          <th class="{% if four_day_week %}cell-friday-locked{% endif %}">Fr</th>
        </tr>
      </thead>
      <tbody>
        {% for emp in employees %}
        {% set row = loop.index0 %}
        <tr>
          <td class="emp">{{ emp.name }}</td>
          {% for day in range(5) %}
          {% set key = (row, day) %}
          <td class="
            cell
            {% if four_day_week and day == 4 %}cell-friday-locked{% endif %}
          ">
            <div style="white-space:pre-line;">
              {{ cells.get(key, '') }}
            </div>
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p style="margin-top:10px;color:#64748b;">
      üîç Ansicht nur zur Einsicht ‚Äì √Ñnderungen sind hier nicht m√∂glich.
    </p>
    {% endblock %}
    """

    template = Template(template_str)
    html_content = template.render(
        standort=standort,
        year=year,
        kw=kw,
        employees=employees,
        cells=cells,
        four_day_week=four_day_week,
    )
    return HTMLResponse(content=html_content)
