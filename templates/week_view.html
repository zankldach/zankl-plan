
{% extends "base.html" %}
{% block title %}View ¬∑ {{ standort|capitalize }} ¬∑ KW {{ kw }}{% endblock %}

{% block head %}
<style>
  #weekTable {
    width:100%;
    border-collapse:separate; border-spacing:0; table-layout:fixed;
    background:#fff; border:1px solid #d9dee5; border-radius:8px; overflow:hidden;
    box-shadow:0 3px 12px rgba(0,0,0,0.06);
  }
  #weekTable thead th {
    position:sticky; top:0; z-index:2;
    background:#0b57d0; color:#fff; padding:8px 6px; font-weight:700; text-align:center;
  }
  #weekTable thead th:first-child,
  #weekTable tbody td:first-child {
    position:sticky; left:0; z-index:1; background:#f7f9fc; font-weight:600; width:180px; text-align:left;
  }
  #weekTable tbody td {
    border-top:1px solid #eef2f6; border-right:1px solid #eef2f6;
    padding:4px 6px; height:54px; vertical-align:middle;
  }
  textarea.cell {
    width:100%; height:46px; padding:4px 6px; border:none; background:transparent;
    text-align:center; font-size:13px; resize:none; outline:none; color:#0f172a; cursor:default;
    white-space:pre-wrap;
  }
  /* Freitag dunkler in View */
  td.cell-friday-locked { background:#e2e8f0 !important; }
  td.cell-friday-locked textarea.cell { color:#475569; }
</style>
{% endblock %}

{% block content %}
<h1>
  Wochenplan ¬∑ {{ standort|capitalize }}
  <small style="color:#64748b;">KW {{ kw }} / {{ year }}</small>
</h1>

<table id="weekTable">
  <thead>
    <tr>
      <th>Mitarbeiter</th>
      {% for day in days %}
        <th>{{ day.label }}<br><small>{{ day.date }}</small></th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for row in grid %}
      {% set r = loop.index0 %}
      <tr>
        <td>
          {% if employees and employees|length > r and employees[r] and employees[r].name %}
            {{ employees[r].name }}
          {% else %}
            <span style="color:#94a3b8;">Unbenannt</span>
          {% endif %}
        </td>
        {% for cell in row %}
          {% set d = loop.index0 %}
          <td class="{% if four_day_week and d == 4 %}cell-friday-locked{% endif %}">
            <textarea class="cell" readonly>{{ (cell.text or '') | e }}</textarea>
          </td>
        {% endfor %}
      </tr>
    {% endfor %}
  </tbody>
</table>

<p style="margin-top:10px;color:#64748b;">
  üîç Reine Ansicht ‚Äì √Ñnderungen sind hier nicht m√∂glich.
  {% if four_day_week %} ¬∑ Hinweis: Freitag ist im 4‚ÄëTage‚ÄëModell schreibgesch√ºtzt.{% endif %}
</p>
{% endblock %}

{% block scripts %}
<script>
(function () {
  // gleiche Farb-Utility wie in Edit
  const RESERVED_RED = new Set(["urlaub","krank","arzt","za","xxx","x","xx"]);
  const norm = s => (s || "").trim().toLowerCase().replace(/\s+/g, " ");
  function hashCode(str) { let h=0; for (let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
  function colorFor(text) {
    const n = norm(text);
    if (!n) return null;
    if (RESERVED_RED.has(n)) return { bg: "hsla(0, 85%, 67%, 0.70)", border: "hsl(0, 82%, 42%)" };
    let h = hashCode(n) % 360;
    if (h <= 20 || h >= 340) h = (h + 40) % 360;
    const s = 70, l = 80;
    return { bg: `hsla(${h}, ${s}%, ${l}%, 0.65)`, border: `hsl(${h}, ${s}%, ${Math.max(40, l-25)}%)` };
  }
  function applyColorsView() {
    document.querySelectorAll('#weekTable textarea.cell').forEach(inp=>{
      const c = colorFor(inp.value);
      if (c){ inp.style.background=c.bg; inp.style.border=`1px solid ${c.border}`; inp.style.borderRadius='6px'; }
      else { inp.style.background='transparent'; inp.style.border='none'; }
    });
  }
  document.addEventListener('DOMContentLoaded', applyColorsView);
  window.addEventListener('load', applyColorsView);
})();
</script>
{% endblock %}
