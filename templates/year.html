{# templates/year.html — AUSTAUSCHDATEI #}
{% extends "base.html" %}
{% block title %}Jahresplanung{% endblock %}

{% block head %}
<style>
  :root{
    --dayw: 96px;
    --leftw: 220px;
    --rowh: 34px;

    --border:#d9dee5;
    --muted:#64748b;
    --bg:#ffffff;
    --soft:#f8fafc;

    --cap:#e5e7eb;   /* Stammkapazität (grau unten) */
    --capText:#334155;
  }

  h1{ margin:0 0 10px 0; }
  .year-topbar{
    display:flex; justify-content:space-between; align-items:center;
    gap:12px; flex-wrap:wrap;
    margin-bottom:12px;
  }

  .btn{
    border:1px solid var(--border);
    background:#fff;
    border-radius:8px;
    padding:8px 10px;
    cursor:pointer;
    font-weight:600;
  }
  .btn:hover{ background:var(--soft); }

  /* Horizontal scroll wrapper */
  .year-scroll{
    overflow-x:auto;
    overflow-y:hidden;
    width:100%;
    border:1px solid var(--border);
    border-radius:12px;
    background:var(--bg);
  }

  /* This is what becomes wide and triggers scrollbar */
  .year-grid{
    min-width:max-content;
  }

  /* Global header */
  .grid-header{
    display:grid;
    grid-template-columns: var(--leftw) repeat({{ days|length }}, var(--dayw));
    position:sticky;
    top:0;
    z-index:5;
    background:var(--bg);
    border-bottom:1px solid var(--border);
  }
  .grid-header .corner{
    padding:10px 10px;
    font-weight:700;
    border-right:1px solid var(--border);
    background:linear-gradient(#fff, #fbfdff);
  }
  .day-head{
    padding:8px 6px;
    border-right:1px solid var(--border);
    text-align:center;
    user-select:none;
    cursor:pointer;
  }
  .day-head:hover{ background:var(--soft); }
  .day-head .dow{ font-weight:800; }
  .day-head .dmy{
    margin-top:2px;
    font-size:12px;
    color:var(--muted);
  }

  /* Sections stacked vertically */
  .section{
    border-top:1px solid var(--border);
  }
  .section:first-child{ border-top:0; }

  .section-title{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px;
    padding:10px 10px;
    border-bottom:1px solid var(--border);
    background:linear-gradient(#fff, #fbfdff);
  }
  .section-title h2{
    margin:0;
    font-size:16px;
  }

  .rowcount{
    display:flex; align-items:center; gap:8px;
    font-weight:700;
    color:#0f172a;
  }
  .rowcount button{
    width:32px; height:28px;
    border-radius:8px;
    border:1px solid var(--border);
    background:#fff;
    cursor:pointer;
    font-weight:900;
  }
  .rowcount button:hover{ background:var(--soft); }
  .rowcount .cnt{
    min-width:34px;
    text-align:center;
  }

  /* Only show friday controls in RES section (requested) */
  .friday-panel{
    padding:8px 10px 12px 10px;
    border-top:1px dashed var(--border);
    margin-top:8px;
  }
  .friday-panel b{ display:block; margin-bottom:6px; }
  .friday-list{
    display:flex; flex-wrap:wrap;
    gap:10px 14px;
    align-items:center;
  }
  .friday-item{
    font-size:13px;
    color:#0f172a;
    background:var(--soft);
    border:1px solid var(--border);
    padding:6px 8px;
    border-radius:999px;
    user-select:none;
  }

  /* One section body: left labels + right grid */
  .section-body{
    position:relative;
    display:grid;
    grid-template-columns: var(--leftw) 1fr;
  }

  .row-labels{
    border-right:1px solid var(--border);
    background:#fff;
  }
  .row-label{
    height:var(--rowh);
    display:flex;
    align-items:center;
    padding:0 10px;
    border-bottom:1px solid #eef2f6;
    font-weight:600;
    color:#0f172a;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* Stammkapazität: unterste 4 Zeilen grau */
  .row-labels .row-label.cap{ background:var(--cap); color:var(--capText); }

  .grid-cells{
    position:relative;
    background:#fff;
  }

  /* grid lines (columns) */
  .grid-lines{
    display:grid;
    grid-template-columns: repeat({{ days|length }}, var(--dayw));
    position:absolute;
    inset:0;
    z-index:1;
  }
  .grid-lines .col{
    border-right:1px solid #eef2f6;
  }

  /* row lines (horizontal) */
  .row-lines{
    position:absolute;
    inset:0;
    z-index:1;
  }
  .row-lines .rline{
    height:var(--rowh);
    border-bottom:1px solid #eef2f6;
  }

  /* job overlay */
  .jobs-layer{
    position:absolute;
    inset:0;
    z-index:2;
    pointer-events:none; /* UI-only for now */
  }

  .job-card{
    position:absolute;
    border-radius:10px;
    border:2px solid rgba(0,0,0,0.25);
    box-shadow:0 4px 14px rgba(0,0,0,0.12);

    /* CENTER TEXT (requested) */
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;

    padding:6px 10px;
    font-weight:800;
    color:#0f172a;
    line-height:1.15;
    overflow:hidden;
  }
  .job-card .note-dot{
    position:absolute;
    top:6px; right:6px;
    width:10px; height:10px;
    border-radius:999px;
    background:#2563eb;
  }

  /* color mapping */
  .c-blue  { background:#bfdbfe; }
  .c-yellow{ background:#fde68a; }
  .c-red   { background:#fecaca; }
  .c-green { background:#bbf7d0; }

  .job-card small{
    display:block;
    font-weight:700;
    opacity:.85;
    margin-top:3px;
  }

  /* Footer help */
  .hint{
    margin-top:10px;
    color:var(--muted);
    font-size:13px;
  }
</style>
{% endblock %}

{% block content %}
<h1>Jahresplanung</h1>

<div class="year-topbar">
  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <button class="btn" id="btn-new">+ Neue Baustelle</button>
    <button class="btn" id="btn-refresh" title="Neu laden">↻ Reload</button>
  </div>

  <div class="hint">
    Tipp: Klick auf einen Tag oben → Feiertag an/aus (global). Freitag-Override ist global und wird unten bei „Ressourcen“ gesteuert.
  </div>
</div>

<div class="year-scroll">
  <div class="year-grid">

    <!-- HEADER: days -->
    <div class="grid-header">
      <div class="corner">Ressourcen / Zeit</div>

      {% for d in days %}
        {# dd.mm.yy requested (we use ymd split) #}
        {% set yy = d.ymd[2:4] %}
        {% set mm = d.ymd[5:7] %}
        {% set dd = d.ymd[8:10] %}
        <div class="day-head" data-day="{{ d.ymd }}">
          <div class="dow">{{ d.label }}</div>
          <div class="dmy">{{ dd }}.{{ mm }}.{{ yy }}</div>
        </div>
      {% endfor %}
    </div>

    {# helper macro: render a section #}
    {% macro render_section(sec_key, title) %}
      <div class="section" data-section="{{ sec_key }}">
        <div class="section-title">
          <div>
            <h2>{{ title }}</h2>

            {% if sec_key == "res" %}
              <!-- Friday panel ONLY here (requested) -->
              <div class="friday-panel">
                <b>Freitag je KW (global)</b>
                <div class="friday-list">
                  {% for k in kw_map %}
                    <label class="friday-item">
                      <input type="checkbox"
                             data-year="{{ k.year }}"
                             data-kw="{{ k.kw }}"
                             {% if k.show_friday %}checked{% endif %}>
                      KW {{ k.kw }}
                    </label>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>

          <div class="rowcount">
            <button type="button" data-sec="{{ sec_key }}" data-delta="-1">−</button>
            <span class="cnt" id="cnt-{{ sec_key }}">{{ rows[sec_key]|length }}</span>
            <button type="button" data-sec="{{ sec_key }}" data-delta="1">+</button>
          </div>
        </div>

        <div class="section-body">
          <!-- left labels -->
          <div class="row-labels">
            {% set n = rows[sec_key]|length %}
            {% for r in rows[sec_key] %}
              {% set is_cap = (loop.index0 >= (n - 4)) %}
              <div class="row-label {% if is_cap %}cap{% endif %}">
                {{ r.name }}
              </div>
            {% endfor %}
          </div>

          <!-- right grid -->
          <div class="grid-cells" style="height: calc({{ rows[sec_key]|length }} * var(--rowh));">
            <!-- vertical lines -->
            <div class="grid-lines">
              {% for _ in days %}
                <div class="col"></div>
              {% endfor %}
            </div>

            <!-- horizontal lines -->
            <div class="row-lines">
              {% for _ in rows[sec_key] %}
                <div class="rline"></div>
              {% endfor %}
            </div>

            <!-- jobs -->
            <div class="jobs-layer">
              {% for j in jobs %}
                {% if j.section == sec_key %}
                  <div class="job-card c-{{ j.color }}"
                       style="
                         left: calc({{ j.col_start }} * var(--dayw) + 6px);
                         top:  calc({{ j.row_index }} * var(--rowh) + 4px);
                         width: calc({{ j.col_span }} * var(--dayw) - 12px);
                         height: calc({{ j.height_rows }} * var(--rowh) - 8px);
                       "
                       title="{{ j.title }}{% if j.note %} — {{ j.note }}{% endif %}">
                    {% if j.note %}
                      <span class="note-dot"></span>
                    {% endif %}
                    <div>
                      {{ j.title }}
                      <small>{{ j.duration_days }} AT</small>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endmacro %}

    {{ render_section("eb", "Standort Engelbrechts") }}
    {{ render_section("res", "Ressourcen") }}
    {{ render_section("gg", "Standort Groß Gerungs") }}

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Reload
  document.getElementById('btn-refresh')?.addEventListener('click', ()=>location.reload());

  // Toggle Holiday (click on day header)
  document.querySelectorAll('.day-head').forEach(el=>{
    el.addEventListener('click', async ()=>{
      const day = el.dataset.day;
      if(!day) return;

      const res = await fetch('/api/year/toggle-holiday', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ day })
      });

      if(!res.ok){
        alert('Fehler beim Feiertag setzen');
        return;
      }
      // Workday-logik beeinflusst Spalten → reload
      location.reload();
    });
  });

  // Friday override (ONLY in resources panel)
  document.querySelectorAll('.friday-panel input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', async ()=>{
      const year = parseInt(cb.dataset.year, 10);
      const kw = parseInt(cb.dataset.kw, 10);
      const show = cb.checked;

      const res = await fetch('/api/year/set-friday', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ year, kw, show_friday: show })
      });

      if(!res.ok){
        alert('Fehler beim Speichern der Freitag-Einstellung');
        cb.checked = !show;
        return;
      }
      location.reload();
    });
  });

  // Rowcount +/- (EB / RES / GG)
  async function setRowCount(section, count){
    const res = await fetch('/api/year/set-row-count', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ section, count })
    });

    let j = {};
    try { j = await res.json(); } catch(e){}

    if(!res.ok || !j.ok){
      if(j && j.error === 'jobs_outside_range'){
        alert('Kann nicht verkleinern: Es liegen Baustellen in Zeilen, die abgeschnitten würden.');
      }else{
        alert('Fehler beim Speichern der Zeilenanzahl.');
      }
      return false;
    }
    location.reload();
    return true;
  }

  document.querySelectorAll('.rowcount button').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const sec = btn.dataset.sec;
      const delta = parseInt(btn.dataset.delta, 10);
      const cntEl = document.getElementById('cnt-'+sec);
      const cur = parseInt(cntEl.textContent, 10) || 1;
      const next = Math.max(1, cur + delta);
      await setRowCount(sec, next);
    });
  });

  // Minimal "Neue Baustelle" (prompt-basiert)
  document.getElementById('btn-new')?.addEventListener('click', async ()=>{
    const title = (prompt('Name, Ort (unique):', '') || '').trim();
    if(!title) return;

    const start_date = (prompt('Startdatum (YYYY-MM-DD):', new Date().toISOString().slice(0,10)) || '').trim();
    if(!start_date) return;

    const duration_days = parseInt(prompt('Dauer in Arbeitstagen:', '3') || '3', 10);
    const height_rows = parseInt(prompt('Anzahl Mitarbeiter (Höhe in Zeilen):', '2') || '2', 10);

    const section = (prompt("Bereich: eb / res / gg", "eb") || "eb").trim();
    const row_index = parseInt(prompt("Startzeile (0 = ganz oben):", "0") || "0", 10);

    const color = (prompt("Art/Farbe: blue (fix) / yellow (verschiebbar) / red (urlaub) / green (intern)", "yellow") || "yellow").trim();
    const note = (prompt("Zusatzinfo (optional):", "") || "").trim();

    const res = await fetch('/api/year/create-job', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ title, start_date, duration_days, height_rows, section, row_index, color, note })
    });

    const j = await res.json().catch(()=>({}));

    if(!res.ok || !j.ok){
      alert(j.error || 'Fehler beim Anlegen');
      return;
    }
    location.reload();
  });
</script>
{% endblock %}
