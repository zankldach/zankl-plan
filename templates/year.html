{% extends "base.html" %}
{% block title %}Jahresplanung{% endblock %}

{% block head %}
<style>
  .year-topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; flex-wrap:wrap; margin-bottom:12px;
  }
  .year-topbar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    border:1px solid #d9dee5; background:#fff; padding:8px 10px; border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
  }
  .btn{
    border:1px solid #d9dee5; background:#fff; padding:8px 10px; border-radius:10px;
    cursor:pointer;
  }
  .btn:hover{ background:#f8fafc; }
  .btn.primary{ background:#0b57d0; color:#fff; border-color:#0b57d0; }
  .btn.primary:hover{ filter:brightness(0.95); }

  /* Row count controls */
  .rc{ display:inline-flex; align-items:center; gap:8px; }
  .rc label{ font-size:12px; font-weight:800; opacity:.85; }
  .rc input{
    width:64px;
    padding:6px 8px;
    border:1px solid #d9dee5;
    border-radius:10px;
    font-size:13px;
  }

  /* Scroll-Container */
.year-scroll{
    position:relative;
    overflow-x:auto;
    overflow-y:hidden;
    border:1px solid #d9dee5;
    border-radius:12px;
    background:#fff;
    box-shadow:0 3px 12px rgba(0,0,0,0.06);
}
#jobLayer{
  position:absolute;
  top:0; left:0;
  width:100%;
  height:100%;
  z-index:4;
  pointer-events:none; /* Zellen bleiben klickbar */
}

.job{
  pointer-events:auto;
  z-index:5;
}



  table.year{
    border-collapse:separate;
    border-spacing:0;
    width:max-content;
    table-layout:fixed;
    font-size:13px;
  }

  /* Sticky Header */
  table.year thead th{
    position:sticky;
    top:0;
    z-index:3;
    background:#0b57d0;
    color:#fff;
    border-bottom:1px solid rgba(255,255,255,0.2);
    padding:6px 6px;
    white-space:nowrap;
    text-align:center;
  }

  /* Sticky linke Spalte */
  .sticky-col{
    position:sticky;
    left:0;
    z-index:2;
    background:#fff;
    border-right:1px solid #e5e7eb;
  }
  thead .sticky-col{
    z-index:10;
    background:#0b57d0;
    color:#fff;
    border-right:1px solid rgba(255,255,255,0.25);
  }

  /* Header 1: KW (Gruppiert) */
  .kw-row th{ padding-top:8px; padding-bottom:8px; font-size:12px; }
  .kw-group{ text-align:center; }
  .kw-cell{ display:flex; align-items:center; justify-content:center; gap:10px; }
  .kw-mini{ font-weight:900; opacity:.95; }
  .kw-toggle{
    display:flex; align-items:center; gap:6px;
    font-size:12px; opacity:0.95; user-select:none;
    padding:2px 8px;
    border-radius:999px;
    background:rgba(255,255,255,0.14);
  }
  .kw-toggle input{ transform:translateY(1px); }

  /* Header 2: Tag + Datum */
  .day-row th{ padding-top:8px; padding-bottom:8px; }
  .day-label{ font-weight:900; line-height:1.05; }
  .day-date{ font-size:11px; opacity:0.90; margin-top:2px; }

  /* Body Zellen */
  table.year tbody th,
  table.year tbody td{
    border-bottom:1px solid #eef2f7;
    border-right:1px solid #eef2f7;
    padding:0;
  }
table.year tbody td{
    width:110px;
    min-width:110px;
    max-width:110px;
    height:28px;
    position:relative;
    overflow:visible;
    z-index:1;
}


  /* Abschnitt-Header */
  tr.section-head th{
    background:#f1f5f9;
    font-weight:900;
    border-top:2px solid #cbd5e1;
  }
  tr.section-head td{
    background:#f1f5f9;
    height:22px;
  }

  /* Optische Trennzeile */
  tr.section-gap th,
  tr.section-gap td{
    background:#ffffff !important;
    height:10px;
    border:0 !important;
  }

  /* Untere 4 Zeilen grau */
  tr.capacity th,
  tr.capacity td{
    background:#f3f4f6 !important;
  }

  /* Grid click selection */
  td.cell{ cursor:pointer; }
  td.cell.is-selected{
    outline:2px solid #0b57d0;
    outline-offset:-2px;
  }

  /* Montags-Trennstrich (fett links) */
  th.mondayStart,
  td.mondayStart{
    border-left:3px solid #0f172a !important;
  }

  /* Jobs */
.job{
  position:absolute;
  border-radius:8px;
  border:1px solid rgba(0,0,0,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:3px 6px;
  box-sizing:border-box;
  overflow:hidden;
  user-select:none;

  z-index:3;
  pointer-events:auto;

  }
  .job small.dot{
    position:absolute;
    right:6px;
    top:6px;
    width:10px;
    height:10px;
    border-radius:50%;
    background:#1d4ed8;
  }

  /* Farben */
  .c-blue{ background:#93c5fd; }
  .c-yellow{ background:#fde68a; }
  .c-red{ background:#fca5a5; }
  .c-green{ background:#86efac; }

  .c-white{
    background:#ffffff;
    border:2px solid #cbd5e1;
    opacity:0.6;
  }
  
  /* Konflikt (Überschneidung) -> schwarz */

  /* Rechtsklick-Menü */
  .ctx{
    position:fixed;
    z-index:9999;
    background:#fff;
    border:1px solid #d9dee5;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);
    min-width:180px;
    display:none;
    overflow:hidden;
  }
  .ctx button{
    width:100%;
    text-align:left;
    border:0;
    background:#fff;
    padding:10px 12px;
    cursor:pointer;
    font-size:13px;
  }
  .ctx button:hover{ background:#f8fafc; }
  .ctx .danger{ color:#b91c1c; }

  /* Ressourcen-Zeilennamen editierbar */
  .rowname-edit{ border-radius:6px; padding:4px 6px; }
  .rowname-edit[contenteditable="true"]:hover{ background:#f8fafc; outline:1px dashed #cbd5e1; }
  .rowname-edit[contenteditable="true"]:focus{ background:#fff; outline:2px solid #0b57d0; }

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0;
    background:rgba(15,23,42,0.45);
    display:none; align-items:center; justify-content:center;
    z-index:9998;
  }
  .modal{
    width:min(520px, calc(100vw - 24px));
    background:#fff;
    border-radius:14px;
    border:1px solid #d9dee5;
    box-shadow:0 20px 60px rgba(0,0,0,.25);
    overflow:hidden;
  }
  .modal header{
    padding:12px 14px;
    background:#0b57d0;
    color:#fff;
    font-weight:900;
    display:flex; align-items:center; justify-content:space-between;
  }
  .modal .body{ padding:14px; display:grid; gap:10px; }
  .modal label{ font-weight:800; font-size:13px; }
  .modal input, .modal textarea, .modal select{
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #d9dee5;
    font-size:14px;
  }
  .modal footer{
    padding:12px 14px;
    display:flex;
    justify-content:flex-end;
    gap:10px;
    border-top:1px solid #eef2f7;
  }

  .hint{ font-size:12px; color:#334155; }

.conflict-cell{ background:#000 !important; }
.conflict-overlay{
  position:absolute;
  background:#000;
  opacity:0.85;
  z-index: 999;       /* über den Jobs */
  pointer-events:none; /* nichts blockieren */
}


</style>
{% endblock %}

{% block content %}

{% set y = year if year is defined else 2025 %}

<div class="year-topbar">
  <div class="left">
    <div class="pill">
      <b>Jahresplanung</b>
      <span style="opacity:.75;">|</span>
      <span>Jahr: <b>{{ y }}</b></span>
    </div>

    <a class="btn" href="/year?year={{ y-1 }}">← {{ y-1 }}</a>
    <a class="btn" href="/year?year={{ y+1 }}">{{ y+1 }} →</a>

    <button class="btn primary" id="btnNew">+ Neue Baustelle</button>

    <div class="pill hint">
      Starttag wählen: <b>in Tabelle klicken</b> → dann „Neue Baustelle“
    </div>

    <div class="pill">
      <div class="rc">
        <label>EB</label>
        <input id="rcEb" type="number" min="1" value="{{ row_counts.eb if row_counts is defined else (rows.eb|length) }}">
      </div>
      <div class="rc">
        <label>RES</label>
        <input id="rcRes" type="number" min="1" value="{{ row_counts.res if row_counts is defined else (rows.res|length) }}">
      </div>
      <div class="rc">
        <label>GG</label>
        <input id="rcGg" type="number" min="1" value="{{ row_counts.gg if row_counts is defined else (rows.gg|length) }}">
      </div>
      <button class="btn" id="btnSaveRows" type="button">Zeilen speichern</button>
    </div>
  </div>
</div>

<div class="year-scroll" id="yearScroll">
  <div id="jobLayer"></div>
  <table class="year" id="yearTable">
    <thead>
      <tr class="kw-row">
        <th class="sticky-col">KW / Freitag</th>
        {% for g in week_groups %}
          <th class="kw-group" colspan="{{ g.span }}">
            <div class="kw-cell">
              <span class="kw-mini">KW {{ g.kw }}</span>
              <label class="kw-toggle" title="Freitag für diese KW ein/ausblenden (global)">
                <input type="checkbox"
                       class="kwFrToggle"
                       data-year="{{ g.year }}"
                       data-kw="{{ g.kw }}"
                       {% if g.show_friday %}checked{% endif %}>
                Fr
              </label>
            </div>
          </th>
        {% endfor %}
      </tr>

      <tr class="day-row">
        <th class="sticky-col"></th>
        {% for d in days %}
          <th data-ymd="{{ d.ymd }}">
            <div class="day-label">{{ d.label }}</div>
            <div class="day-date">{{ d.date_full if d.date_full is defined else d.date }}</div>
          </th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      <!-- EB -->
      <tr class="section-head">
        <th class="sticky-col">Standort EB</th>
        {% for _ in days %}<td></td>{% endfor %}
      </tr>

      {% set eb_count = rows.eb|length %}
      {% for r in rows.eb %}
        {% set is_cap = (r.row_index >= eb_count-4) %}
        <tr class="{% if is_cap %}capacity{% endif %}">
          <th class="sticky-col"><span>{{ r.name }}</span></th>
          {% for d in days %}
            <td class="cell" data-section="eb" data-row="{{ r.row_index }}" data-ymd="{{ d.ymd }}"></td>
          {% endfor %}
        </tr>
      {% endfor %}

      <tr class="section-gap">
        <th class="sticky-col"></th>
        {% for _ in days %}<td></td>{% endfor %}
      </tr>

      <!-- RES -->
      <tr class="section-head">
        <th class="sticky-col">Ressourcen</th>
        {% for _ in days %}<td></td>{% endfor %}
      </tr>

      {% set res_count = rows.res|length %}
      {% for r in rows.res %}
        {% set is_cap = (r.row_index >= res_count-4) %}
        <tr class="{% if is_cap %}capacity{% endif %}">
          <th class="sticky-col">
            <span class="rowname-edit"
                  contenteditable="true"
                  data-rowid="{{ r.id }}"
                  data-section="res"
                  data-row="{{ r.row_index }}"
                  spellcheck="false">{{ r.name }}</span>
          </th>
          {% for d in days %}
            <td class="cell" data-section="res" data-row="{{ r.row_index }}" data-ymd="{{ d.ymd }}"></td>
          {% endfor %}
        </tr>
      {% endfor %}

      <tr class="section-gap">
        <th class="sticky-col"></th>
        {% for _ in days %}<td></td>{% endfor %}
      </tr>

      <!-- GG -->
      <tr class="section-head">
        <th class="sticky-col">Standort GG</th>
        {% for _ in days %}<td></td>{% endfor %}
      </tr>

      {% set gg_count = rows.gg|length %}
      {% for r in rows.gg %}
        {% set is_cap = (r.row_index >= gg_count-4) %}
        <tr class="{% if is_cap %}capacity{% endif %}">
          <th class="sticky-col"><span>{{ r.name }}</span></th>
          {% for d in days %}
            <td class="cell" data-section="gg" data-row="{{ r.row_index }}" data-ymd="{{ d.ymd }}"></td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="ctx" id="ctxMenu">
  <button id="ctxEdit">Bearbeiten</button>

  <div style="padding:10px 12px; border-top:1px solid #eef2f7;">
    <div style="font-size:12px; font-weight:800; margin-bottom:6px;">Farbe</div>
    <select id="ctxColor" style="width:100%; padding:8px 10px; border-radius:10px; border:1px solid #d9dee5; font-size:13px;">
      <option value="blue">Fixtermin (blau)</option>
      <option value="yellow">Verschiebbar (gelb)</option>
      <option value="red">Urlaub (rot)</option>
      <option value="green">Intern (grün)</option>
      <option value="white">Verrechnet (weiß)</option>
    </select>

    <button id="ctxWhite" class="btn" type="button"
            style="width:100%; margin-top:8px; padding:8px 10px; border-radius:10px;">
      Verrechnet (weiß)
    </button>
  </div>

  <button class="danger" id="ctxDelete" style="border-top:1px solid #eef2f7;">Löschen</button>
</div>


<div class="modal-backdrop" id="modalBg">
  <div class="modal">
    <header>
      <span id="modalTitle">Neue Baustelle</span>
      <button class="btn" id="btnClose" type="button">✕</button>
    </header>

    <div class="body">
      <div>
        <label>Name, Ort</label>
        <input id="fTitle" placeholder="z.B. Huber, Zwettl">
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div>
          <label>Dauer (Arbeitstage)</label>
          <input id="fDur" type="number" min="1" value="5">
        </div>
        <div>
          <label>Mitarbeiter (Höhe in Zeilen)</label>
          <input id="fHeight" type="number" min="1" value="1">
        </div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div>
          <label>Start (geklickter Tag)</label>
          <input id="fStart" type="text" readonly>
          <div class="hint">Wird über Klick in der Tabelle gesetzt.</div>
        </div>
        <div>
          <label>Art</label>
          <select id="fColor">
            <option value="blue">Fixtermin (blau)</option>
            <option value="yellow" selected>Verschiebbar (gelb)</option>
            <option value="red">Urlaub (rot)</option>
            <option value="green">Intern (grün)</option>
          </select>
        </div>
      </div>

      <div>
        <label>Zusatzinfo (optional)</label>
        <textarea id="fNote" rows="3" placeholder="Notiz…"></textarea>
      </div>

      <div class="hint">
        Zielposition kommt vom Klick: Bereich (EB/RES/GG) + Zeile + Tag.
      </div>
    </div>

    <footer>
      <button class="btn" id="btnCancel" type="button">Abbrechen</button>
      <button class="btn primary" id="btnSave" type="button">Speichern</button>
    </footer>
  </div>
</div>

<script>
  const jobs = {{ jobs|tojson }};
  const days = {{ days|tojson }};
  const conflictCells = {{ conflict_cells|tojson }};


  const yearTable = document.getElementById('yearTable');
  const modalBg = document.getElementById('modalBg');
  const btnNew = document.getElementById('btnNew');
  const btnClose = document.getElementById('btnClose');
  const btnCancel = document.getElementById('btnCancel');
  const btnSave = document.getElementById('btnSave');

  const fTitle = document.getElementById('fTitle');
  const fDur = document.getElementById('fDur');
  const fHeight = document.getElementById('fHeight');
  const fStart = document.getElementById('fStart');
  const fColor = document.getElementById('fColor');
  const fNote = document.getElementById('fNote');

  const btnSaveRows = document.getElementById('btnSaveRows');
  const rcEb = document.getElementById('rcEb');
  const rcRes = document.getElementById('rcRes');
  const rcGg = document.getElementById('rcGg');

  let anchor = null; // {section,row,ymd}
  let selectedCellEl = null;
  let editJobId = null;   // null = create, sonst update
  let editJobObj = null;

function openModal(){
  modalBg.style.display = 'flex';
  document.getElementById('modalTitle').textContent = editJobId ? 'Baustelle bearbeiten' : 'Neue Baustelle';
  btnSave.textContent = editJobId ? 'Änderungen speichern' : 'Speichern';
}

function closeModal(){
  modalBg.style.display = 'none';
  editJobId = null;
  editJobObj = null;
  btnSave.textContent = 'Speichern';
  document.getElementById('modalTitle').textContent = 'Neue Baustelle';
}


  btnNew.addEventListener('click', () => {
    if (!anchor) {
      alert('Bitte zuerst einen Starttag in der Tabelle anklicken.');
      return;
    }
    fTitle.value = '';
    fDur.value = 5;
    fHeight.value = 1;
    fStart.value = anchor.ymd + ' (' + anchor.section.toUpperCase() + ', Zeile ' + (anchor.row+1) + ')';
    fColor.value = 'yellow';
    fNote.value = '';
    openModal();
  });

  btnClose.addEventListener('click', closeModal);
  btnCancel.addEventListener('click', closeModal);
  modalBg.addEventListener('click', (e) => { if (e.target === modalBg) closeModal(); });

function selectCell(td){
  if (!td) return;
  if (selectedCellEl) selectedCellEl.classList.remove('is-selected');
  selectedCellEl = td;
  td.classList.add('is-selected');
  anchor = {
    section: td.dataset.section,
    row: parseInt(td.dataset.row, 10),
    ymd: td.dataset.ymd
  };
}

// Event Delegation: funktioniert auch wenn du auf .job klickst
yearTable.addEventListener('click', (e) => {
  const td = e.target.closest('td.cell');
  if (!td) return;
  selectCell(td);
});


  // KW Freitag Toggle
  document.querySelectorAll('.kwFrToggle').forEach(cb => {
    cb.addEventListener('change', async () => {
      const year = parseInt(cb.dataset.year, 10);
      const kw = parseInt(cb.dataset.kw, 10);
      const show_friday = cb.checked ? 1 : 0;
      try{
        const res = await fetch('/api/year/set-friday', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({year, kw, show_friday})
        });
        if (!res.ok) throw new Error('save failed');
        location.reload();
      }catch(e){
        console.warn(e);
        alert('Konnte Freitag-Override nicht speichern.');
        cb.checked = !cb.checked;
      }
    });
  });

  // Ressourcen-Zeilennamen speichern (blur)
  document.querySelectorAll('.rowname-edit').forEach(el => {
    el.addEventListener('blur', async () => {
      const row_id = parseInt(el.dataset.rowid, 10);
      const name = (el.textContent || '').trim();
      if (!name) return;
      try{
        const res = await fetch('/api/year/update-row-name', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ row_id, name })
        });
        if (!res.ok) throw new Error('save failed');
      }catch(e){
        console.warn(e);
        alert('Konnte Ressourcen-Namen nicht speichern.');
      }
    });
  });

  // Zeilenanzahl speichern
  btnSaveRows.addEventListener('click', async () => {
    const counts = {
      eb: parseInt(rcEb.value || "1", 10),
      res: parseInt(rcRes.value || "1", 10),
      gg: parseInt(rcGg.value || "1", 10),
    };
    try{
      const res = await fetch('/api/year/set-row-counts', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ counts })
      });
      const js = await res.json().catch(()=>({}));
      if (!res.ok || !js.ok){
        alert(js.error || 'Speichern fehlgeschlagen.');
        return;
      }
      location.reload();
    }catch(e){
      console.warn(e);
      alert('Speichern fehlgeschlagen.');
    }
  });

  // Montags-Spalte markieren (fette Trennlinie links)
  function applyMondayStripes(){
    for (let i=0; i<days.length; i++){
      if ((days[i].label || '') === 'Mo'){
        const ymd = days[i].ymd;
        document.querySelectorAll(`th[data-ymd="${ymd}"]`).forEach(el => el.classList.add('mondayStart'));
        document.querySelectorAll(`td.cell[data-ymd="${ymd}"]`).forEach(el => el.classList.add('mondayStart'));
      }
    }
  }

  // ===== Jobs rendern =====
  function findCell(section, rowIndex, colIndex){
    const ymd = days[colIndex]?.ymd;
    if (!ymd) return null;
    return yearTable.querySelector(`td.cell[data-section="${section}"][data-row="${rowIndex}"][data-ymd="${ymd}"]`);
  }


function renderJobs(){
  const layer = document.getElementById('jobLayer');

  // alte Jobs entfernen


  // Overlap-Zellen reset + markieren
  yearTable.querySelectorAll('.conflict-cell').forEach(n => n.classList.remove('conflict-cell'));
  (conflictCells || []).forEach(c => {
    const td = yearTable.querySelector(
      `td.cell[data-section="${c.section}"][data-row="${c.row}"][data-ymd="${c.ymd}"]`
    );
    if (td) td.classList.add('conflict-cell');
  });
// Konflikt-Overlays (sichtbar ÜBER Jobs)
(conflictCells || []).forEach(c => {
  const td = yearTable.querySelector(
    `td.cell[data-section="${c.section}"][data-row="${c.row}"][data-ymd="${c.ymd}"]`
  );
  if (!td) return;

  const r = td.getBoundingClientRect();
  const lr = layer.getBoundingClientRect();

  const o = document.createElement('div');
  o.className = 'conflict-overlay';
  o.style.left = (r.left - lr.left + 1) + 'px';
  o.style.top  = (r.top  - lr.top  + 1) + 'px';
  o.style.width  = (r.width - 2) + 'px';
  o.style.height = (r.height - 2) + 'px';

  layer.appendChild(o);
});

  // Jobs zeichnen
  jobs.forEach(j => {
    const startCell = findCell(j.section, j.row_index, j.col_start);
    if (!startCell) return;

    const cellRect = startCell.getBoundingClientRect();
    const layerRect = layer.getBoundingClientRect();

    const cellH = cellRect.height;
    const cellW = cellRect.width;

    const heightPx = Math.max(cellH * (j.height_rows || 1) - 4, cellH - 4);
    const widthPx  = (cellW * j.col_span) - 4;

    const div = document.createElement('div');
    div.className = `job c-${j.color}`;
   
    div.style.height = heightPx + 'px';
    div.style.width  = widthPx + 'px';
div.style.left  = (cellRect.left - layerRect.left + 2) + 'px';
div.style.top   = (cellRect.top  - layerRect.top  + 2) + 'px';
div.dataset.id  = j.id;

div.title = j.note || '';

div.innerHTML = `
  <div style="display:flex; flex-direction:column; width:100%; line-height:1.05;">
    <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
      ${j.title || ''}
    </div>
    ${j.note ? `
      <div style="font-size:11px; opacity:.85; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        ${j.note}
      </div>
    ` : ''}
  </div>
`;

    layer.appendChild(div);

    // Rechtsklick
    div.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openCtxMenu(e.clientX, e.clientY, j);
    });

    // Klick auf Job = Zelle auswählen
    div.addEventListener('click', (e) => {
      e.stopPropagation();
      selectCell(startCell);
    });
  });
}



  let _rzT = null;
  window.addEventListener('resize', () => {
    clearTimeout(_rzT);
    _rzT = setTimeout(renderJobs, 120);
  });

  // Context Menu
  const ctx = document.getElementById('ctxMenu');
  const ctxEdit = document.getElementById('ctxEdit');
  const ctxDelete = document.getElementById('ctxDelete');
  const ctxColor = document.getElementById('ctxColor');
  const ctxWhite = document.getElementById('ctxWhite');
  let ctxJob = null;

  

function openCtxMenu(x, y, job){
  ctxJob = job;

  // Dropdown auf aktuelle Farbe setzen
  if (ctxColor) ctxColor.value = (job.color || 'yellow');

  ctx.style.display = 'block';
  ctx.style.left = x + 'px';
  ctx.style.top = y + 'px';
}

  function closeCtxMenu(){
    ctx.style.display = 'none';
    ctxJob = null;
  }

  async function saveJobColor(jobId, color){
  try{
    const res = await fetch('/api/year/update-job-color', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id: jobId, color })
    });
    const js = await res.json().catch(()=>({}));
    if (!res.ok || !js.ok) throw new Error(js.error || 'save failed');
    location.reload();
  }catch(e){
    console.warn(e);
    alert('Farbe konnte nicht gespeichert werden.');
  }
}

  document.addEventListener('click', () => {
    if (ctx.style.display === 'block') closeCtxMenu();
  });

  ctxDelete.addEventListener('click', async () => {
    if (!ctxJob) return;
    if (!confirm('Baustelle wirklich löschen?')) return;

    if (ctxColor){
  ctxColor.addEventListener('change', () => {
    if (!ctxJob) return;
    saveJobColor(ctxJob.id, ctxColor.value);
    closeCtxMenu();
  });
}

if (ctxWhite){
  ctxWhite.addEventListener('click', () => {
    if (!ctxJob) return;
    saveJobColor(ctxJob.id, 'white');
    closeCtxMenu();
  });
}

    try{
      const res = await fetch('/api/year/delete-job', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id: ctxJob.id})
      });
      if (!res.ok) throw new Error('delete failed');
      location.reload();
    }catch(e){
      console.warn(e);
      alert('Löschen fehlgeschlagen.');
    }finally{
      closeCtxMenu();
    }
  });

ctxEdit.addEventListener('click', () => {
  if (!ctxJob) return;

  // Edit-Modus setzen
  editJobId = ctxJob.id;
  editJobObj = ctxJob;

  // Anchor auf Start der Baustelle setzen
  anchor = {
    section: ctxJob.section,
    row: parseInt(ctxJob.row_index, 10),
    ymd: ctxJob.start_date // kommt aus DB
  };

  // Optional: Zelle optisch auswählen (Startzelle)
  const startCell = findCell(ctxJob.section, ctxJob.row_index, ctxJob.col_start);
  if (startCell) selectCell(startCell);

  // Felder befüllen
  fTitle.value = ctxJob.title || '';
  fDur.value = parseInt(ctxJob.duration_days || 1, 10);
  fHeight.value = parseInt(ctxJob.height_rows || 1, 10);
  fColor.value = ctxJob.color || 'yellow';
  fNote.value = ctxJob.note || '';

  fStart.value = anchor.ymd + ' (' + anchor.section.toUpperCase() + ', Zeile ' + (anchor.row+1) + ')';

  closeCtxMenu();
  openModal();
});


  // Speichern (create)
  btnSave.addEventListener('click', async () => {
    if (!anchor) return;

    const payload = {
      title: (fTitle.value || '').trim(),
      start_date: anchor.ymd,
      duration_days: parseInt(fDur.value || '1', 10),
      height_rows: parseInt(fHeight.value || '1', 10),
      section: anchor.section,
      row_index: anchor.row,
      color: fColor.value,
      note: (fNote.value || '').trim()
    };

    if (!payload.title){
      alert('Bitte "Name, Ort" ausfüllen.');
      return;
    }

    try{
      const url = editJobId ? '/api/year/update-job' : '/api/year/create-job';
      const body = editJobId ? { ...payload, id: editJobId } : payload;

      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });

      const js = await res.json().catch(()=>({}));
      if (!res.ok || !js.ok){
        alert(js.error || 'Speichern fehlgeschlagen.');
        return;
      }

      closeModal();
      location.reload();
    }catch(e){
      console.warn(e);
      alert('Speichern fehlgeschlagen.');
    }

  });

  applyMondayStripes();
  renderJobs();
</script>
{% endblock %}
