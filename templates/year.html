{% extends "base.html" %}
{% block title %}Jahresplanung{% endblock %}

{% block head %}
<style>
  .year-wrap { display:flex; flex-direction:column; gap:16px; }
  .year-top { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .btn { padding:8px 10px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn:hover { background:#f8fafc; }

  .legend { display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:13px; color:#334155; }
  .dot { width:10px; height:10px; border-radius:999px; display:inline-block; border:1px solid rgba(0,0,0,.2); }
  .c-blue{ background:#3b82f6; } .c-yellow{ background:#f59e0b; } .c-red{ background:#ef4444; } .c-green{ background:#22c55e; }

  /* Bereich-Grid */
  .section {
    border:1px solid #d9dee5;
    background:#fff;
    border-radius:12px;
    overflow:hidden;
    box-shadow: 0 3px 12px rgba(0,0,0,0.06);
  }
  .section .title {
    padding:10px 12px;
    font-weight:800;
    background:#f1f5f9;
    border-bottom:1px solid #e2e8f0;
  }

  .grid {
    position:relative;
    display:grid;
    grid-template-columns: 190px repeat({{ days|length }}, minmax(46px, 1fr));
    grid-auto-rows: 28px;
  }

  .cell {
    border-right:1px solid #eef2f7;
    border-bottom:1px solid #eef2f7;
    padding:6px 8px;
    font-size:12px;
    color:#0f172a;
    background:#fff;
  }
  .cell.header { position:sticky; top:0; z-index:3; background:#0b57d0; color:#fff; font-weight:800; }
  .cell.header.left { left:0; z-index:4; position:sticky; }
  .cell.left { position:sticky; left:0; z-index:2; background:#fff; font-weight:700; }
  .cell.left.gray { background:#f3f4f6; color:#64748b; }
  .cell.gray { background:#f8fafc; }

  .holiday {
    background: repeating-linear-gradient(
      45deg,
      rgba(239,68,68,0.12),
      rgba(239,68,68,0.12) 6px,
      rgba(255,255,255,0.0) 6px,
      rgba(255,255,255,0.0) 12px
    );
  }

  /* Job-Karten */
  .job {
    position:absolute;
    border:1px solid rgba(0,0,0,.25);
    border-radius:10px;
    padding:6px 8px;
    font-size:12px;
    font-weight:800;
    color:#0f172a;
    overflow:hidden;
    box-shadow: 0 4px 14px rgba(0,0,0,0.10);
  }
  .job.blue{ background:rgba(59,130,246,0.35); }
  .job.yellow{ background:rgba(245,158,11,0.35); }
  .job.red{ background:rgba(239,68,68,0.35); }
  .job.green{ background:rgba(34,197,94,0.35); }

  .job .note-dot {
    position:absolute; right:6px; top:6px;
    width:10px; height:10px; border-radius:999px;
    background:#2563eb; border:1px solid rgba(0,0,0,.25);
  }

  .kwbar {
    padding:10px 12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    border-top:1px solid #e2e8f0;
    background:#fff;
  }
  .kwchip {
    display:flex; align-items:center; gap:6px;
    padding:6px 10px;
    border:1px solid #e2e8f0;
    border-radius:999px;
    background:#f8fafc;
    font-size:12px;
  }

  .hint { font-size:12px; color:#475569; margin-top:-8px; }
</style>
{% endblock %}

{% block content %}
<div class="year-wrap">
  <div class="year-top">
    <h1 style="margin:0;">Jahresplanung</h1>
    <button class="btn" id="btnNew">+ Neue Baustelle</button>

    <div class="legend">
      <span><span class="dot c-blue"></span> Fix</span>
      <span><span class="dot c-yellow"></span> Verschiebbar</span>
      <span><span class="dot c-red"></span> Urlaub</span>
      <span><span class="dot c-green"></span> Intern</span>
      <span style="margin-left:10px;">Klick auf Tag im Header = Feiertag toggeln</span>
    </div>
  </div>

  <div class="hint">
    Sicht: ~3 Wochen (15 Arbeitstage). Freitag wird automatisch (Sommer/Winter) gesteuert – Overrides unten pro KW.
  </div>

  {% macro render_section(sec_key, sec_title) %}
  <div class="section" data-section="{{ sec_key }}">
    <div class="title">{{ sec_title }}</div>

    <div class="grid" id="grid-{{ sec_key }}">
      <!-- Header row -->
      <div class="cell header left">Ressource</div>
      {% for d in days %}
        <div class="cell header js-day"
             data-day="{{ d.ymd }}"
             title="Feiertag toggeln ({{ d.ymd }})">
          {{ d.label }}<br>{{ d.date }}
        </div>
      {% endfor %}

      <!-- Body rows -->
      {% set rcount = rows[sec_key]|length %}
      {% for r in rows[sec_key] %}
        {% set is_gray = (loop.index0 >= (rcount - 4)) %}
        <div class="cell left {{ 'gray' if is_gray else '' }}">{{ r.name }}</div>
        {% for d in days %}
          <div class="cell {{ 'gray' if is_gray else '' }}" data-row="{{ r.row_index }}" data-day="{{ d.ymd }}"></div>
        {% endfor %}
      {% endfor %}

      <!-- Jobs as absolute overlays -->
      {% for j in jobs %}
        {% if j.section == sec_key %}
          <div class="job {{ j.color }}"
               data-id="{{ j.id }}"
               style="
                 left: calc(190px + ({{ j.col_start }} * (100% - 190px) / {{ days|length }}));
                 width: calc({{ j.col_span }} * (100% - 190px) / {{ days|length }});
                 top: calc(28px + ({{ j.row_index }} * 28px));
                 height: calc({{ j.height_rows }} * 28px);
               "
               title="Rechtsklick: löschen (MVP)">
            {{ j.title }}
            {% if j.note %}<span class="note-dot" title="Notiz vorhanden"></span>{% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="kwbar">
      {% for k in kw_map %}
        <label class="kwchip">
          <input type="checkbox" class="js-friday"
                 data-year="{{ k.year }}" data-kw="{{ k.kw }}"
                 {% if k.show_friday %}checked{% endif %}>
          KW {{ k.kw }} ({{ k.year }}) – Freitag anzeigen
        </label>
      {% endfor %}
    </div>
  </div>
  {% endmacro %}

  {{ render_section('eb', 'Standort Engelbrechts') }}
  {{ render_section('res', 'Ressourcen') }}
  {{ render_section('gg', 'Standort Groß Gerungs') }}

</div>
{% endblock %}

{% block scripts %}
<script>
async function postJSON(url, payload) {
  const res = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  let data = {};
  try { data = await res.json(); } catch(e) {}
  if (!res.ok) throw new Error((data && data.error) ? data.error : ("HTTP " + res.status));
  return data;
}

// Feiertag toggeln (Header-Klick)
document.querySelectorAll(".js-day").forEach(el => {
  el.addEventListener("click", async () => {
    const day = el.dataset.day;
    try {
      await postJSON("/api/year/toggle-holiday", {day});
      location.reload();
    } catch (e) {
      alert("Fehler: " + e.message);
    }
  });
});

// Freitag Override
document.querySelectorAll(".js-friday").forEach(cb => {
  cb.addEventListener("change", async () => {
    try {
      await postJSON("/api/year/set-friday", {
        year: parseInt(cb.dataset.year, 10),
        kw: parseInt(cb.dataset.kw, 10),
        show_friday: cb.checked ? 1 : 0
      });
      location.reload();
    } catch (e) {
      alert("Fehler: " + e.message);
    }
  });
});

// Neue Baustelle (MVP via prompt)
document.getElementById("btnNew").addEventListener("click", async () => {
  const title = (prompt("Titel (unique, z.B. 'Huber, Zwettl')") || "").trim();
  if (!title) return;

  const start_date = (prompt("Startdatum (YYYY-MM-DD)", new Date().toISOString().slice(0,10)) || "").trim();
  if (!start_date) return;

  const duration_days = parseInt(prompt("Dauer (Arbeitstage)", "5") || "5", 10);
  const height_rows = parseInt(prompt("Anzahl Mitarbeiter (Höhe in Zeilen)", "1") || "1", 10);

  const section = (prompt("Bereich: eb / res / gg", "eb") || "eb").trim();
  const row_index = parseInt(prompt("Startzeile (0-basiert innerhalb Bereich)", "0") || "0", 10);

  const color = (prompt("Art: blue (Fix) / yellow (Verschiebbar) / red (Urlaub) / green (Intern)", "yellow") || "yellow").trim();
  const note = (prompt("Zusatzinfo (optional)") || "").trim();

  try {
    await postJSON("/api/year/create-job", {
      title, start_date,
      duration_days: isNaN(duration_days) ? 1 : duration_days,
      height_rows: isNaN(height_rows) ? 1 : height_rows,
      section, row_index,
      color, note
    });
    location.reload();
  } catch (e) {
    alert("Fehler: " + e.message);
  }
});

// Rechtsklick auf Job: löschen (MVP)
document.querySelectorAll(".job").forEach(j => {
  j.addEventListener("contextmenu", async (ev) => {
    ev.preventDefault();
    const id = parseInt(j.dataset.id, 10);
    if (!id) return;
    if (!confirm("Baustelle löschen?")) return;
    try {
      await postJSON("/api/year/delete-job", {id});
      location.reload();
    } catch (e) {
      alert("Fehler: " + e.message);
    }
  });
});
</script>
{% endblock %}
