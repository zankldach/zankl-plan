{% extends "base.html" %}
{% block title %}Jahresplanung{% endblock %}

{% block head %}
<style>

/* ============================= */
/*  NEU: Wochen-Trennlinien     */
/* ============================= */

.week-sep{
  border-left:3px solid #0f172a !important;
}

.kw-sep{
  border-left:4px solid #0f172a !important;
}

/* ============================= */
/*  Konflikt-Markierung         */
/* ============================= */

.job.is-conflict{
  background:#000 !important;
  color:#fff !important;
  border-color:#000 !important;
}

/* ============================= */
/* Rest bleibt wie bei dir      */
/* ============================= */

.year-topbar{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; flex-wrap:wrap; margin-bottom:12px;
}

.year-scroll{
  overflow-x:auto;
  overflow-y:hidden;
  border:1px solid #d9dee5;
  border-radius:12px;
  background:#fff;
  box-shadow:0 3px 12px rgba(0,0,0,0.06);
}

table.year{
  border-collapse:separate;
  border-spacing:0;
  width:max-content;
  table-layout:fixed;
  font-size:13px;
}

table.year thead th{
  position:sticky;
  top:0;
  z-index:5;
  background:#0b57d0;
  color:#fff;
  border-bottom:1px solid rgba(255,255,255,0.2);
  padding:6px 6px;
  white-space:nowrap;
  text-align:center;
}

.sticky-col{
  position:sticky;
  left:0;
  z-index:8;
  background:#fff;
  border-right:1px solid #e5e7eb;
}

thead .sticky-col{
  z-index:10;
  background:#0b57d0;
  color:#fff;
  border-right:1px solid rgba(255,255,255,0.25);
}

table.year tbody td{
  width:34px;
  height:26px;
  position:relative;
  overflow:visible;
  border-bottom:1px solid #eef2f7;
  border-right:1px solid #eef2f7;
}

/* Jobs */

.job{
  position:absolute;
  top:2px;
  left:2px;
  border-radius:8px;
  border:1px solid rgba(0,0,0,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:3px 6px;
  box-sizing:border-box;
  z-index:50;
  pointer-events:auto;
}

.c-blue{ background:#93c5fd; }
.c-yellow{ background:#fde68a; }
.c-red{ background:#fca5a5; }
.c-green{ background:#86efac; }

</style>
{% endblock %}

{% block content %}

<div class="year-scroll">
<table class="year" id="yearTable">

<thead>

<tr class="kw-row">
<th class="sticky-col">KW</th>
{% for g in week_groups %}
<th class="{% if not loop.first %}kw-sep{% endif %}" colspan="{{ g.span }}">
KW {{ g.kw }}
</th>
{% endfor %}
</tr>

<tr>
<th class="sticky-col"></th>
{% for d in days %}
<th class="{% if d.label == 'Mo' %}week-sep{% endif %}">
{{ d.label }}<br>
<small>{{ d.date_full }}</small>
</th>
{% endfor %}
</tr>

</thead>

<tbody>

{% for sec in ['eb','res','gg'] %}
{% for r in rows[sec] %}
<tr>
<th class="sticky-col">{{ r.name }}</th>
{% for d in days %}
<td class="cell {% if d.label == 'Mo' %}week-sep{% endif %}"
    data-section="{{ sec }}"
    data-row="{{ r.row_index }}"
    data-ymd="{{ d.ymd }}">
</td>
{% endfor %}
</tr>
{% endfor %}
{% endfor %}

</tbody>
</table>
</div>

<script>

const jobs = {{ jobs|tojson }};
const days = {{ days|tojson }};
const yearTable = document.getElementById('yearTable');

/* ============================= */
/* Konflikt-Erkennung            */
/* ============================= */

function detectConflicts(jobs){

  const occupied = {};

  jobs.forEach(j=>{
    for(let c=0;c<j.col_span;c++){
      for(let h=0;h<j.height_rows;h++){
        const key = j.section+"-"+(j.row_index+h)+"-"+(j.col_start+c);
        if(!occupied[key]) occupied[key]=[];
        occupied[key].push(j.id);
      }
    }
  });

  const conflicts = new Set();

  Object.values(occupied).forEach(arr=>{
    if(arr.length>1){
      arr.forEach(id=>conflicts.add(id));
    }
  });

  return conflicts;
}

function findCell(section,rowIndex,colIndex){
  const ymd = days[colIndex]?.ymd;
  return yearTable.querySelector(
    `td[data-section="${section}"][data-row="${rowIndex}"][data-ymd="${ymd}"]`
  );
}

function renderJobs(){

  yearTable.querySelectorAll('.job').forEach(n=>n.remove());

  const conflicts = detectConflicts(jobs);

  jobs.forEach(j=>{

    const startCell = findCell(j.section,j.row_index,j.col_start);
    if(!startCell) return;

    const cellH = startCell.getBoundingClientRect().height;
    const cellW = startCell.getBoundingClientRect().width;

    const heightPx = cellH*j.height_rows-4;
    const widthPx  = cellW*j.col_span-4;

    const div = document.createElement('div');
    div.className = `job c-${j.color}`;
    if(conflicts.has(j.id)){
      div.classList.add('is-conflict');
    }

    div.style.height = heightPx+'px';
    div.style.width  = widthPx+'px';
    div.textContent  = j.title;

    startCell.appendChild(div);
  });

}

window.addEventListener('resize',()=>{
  setTimeout(renderJobs,100);
});

renderJobs();

</script>

{% endblock %}

